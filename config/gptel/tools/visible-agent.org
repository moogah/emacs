#+title: GPTEL Visible Agent Tool
#+author: Jeff Farr
#+property: header-args:emacs-lisp :tangle no
#+auto_tangle: nil

* Introduction

The VisibleAgent tool creates specialized subagents with persistent session tracking.
Agents can run invisibly (default) or in visible buffers for transparency.

Key features:
- Persistent session buffers (can be saved/reopened like any gptel buffer)
- Nested session directories under parent's =subagents/= folder
- Full session persistence (metadata, preset, scope-plan)
- Parent-child linking via metadata
- Proper configuration isolation via =gptel-with-preset=
- Optional visibility - run invisibly with parent buffer status, or show full buffer
- Parent buffer overlay showing agent status

* Basic Configuration
:PROPERTIES:
:header-args:emacs-lisp: :tangle visible-agent.el
:END:

#+begin_src emacs-lisp
;; -*- lexical-binding: t; -*-

(require 'cl-lib)
(require 'gptel)
(require 'gptel-session-constants)
(require 'gptel-session-logging)
(require 'gptel-session-filesystem)
(require 'gptel-session-registry)
(require 'gptel-session-metadata)
(require 'jf-gptel-scope-commands)
#+end_src

* Helper Functions
:PROPERTIES:
:header-args:emacs-lisp: :tangle visible-agent.el
:END:

** Generate Session Slug

#+begin_src emacs-lisp
(defun jf/gptel--visible-agent-generate-slug (agent_type prompt)
  "Generate descriptive slug from AGENT-TYPE and PROMPT for subagent session."
  (let* ((timestamp (format-time-string "%Y%m%d%H%M%S"))
         (prompt-snippet (substring prompt 0 (min 50 (length prompt))))
         (description (replace-regexp-in-string "[^a-z0-9]+" "-"
                        (downcase prompt-snippet)))
         (description (string-trim description "-")))
    (format "%s-%s-%s" (downcase agent_type) timestamp description)))
#+end_src

** Create Subagent Directory

#+begin_src emacs-lisp
(defun jf/gptel--visible-agent-create-directory (parent-dir slug)
  "Create subagent directory under PARENT-DIR/subagents/ with SLUG.
Returns full path to created directory."
  (let* ((subagents-dir (jf/gptel--subagents-dir-path parent-dir))
         (subagent-dir (expand-file-name slug subagents-dir)))
    ;; Create subagents parent directory if needed
    (unless (file-directory-p subagents-dir)
      (make-directory subagents-dir t))
    ;; Create subagent session directory
    (make-directory subagent-dir t)
    (jf/gptel--log 'info "Created subagent directory: %s" subagent-dir)
    subagent-dir))
#+end_src

** Create Subagent Metadata

#+begin_src emacs-lisp
(defun jf/gptel--visible-agent-create-metadata (session-dir parent-session-id agent_type prompt)
  "Create metadata.json for subagent session.
SESSION-DIR is the subagent directory.
PARENT-SESSION-ID links to parent session.
AGENT-TYPE and PROMPT describe the task."
  (let* ((timestamp (format-time-string "%Y-%m-%dT%H:%M:%SZ" nil t))
         (session-id (jf/gptel--session-id-from-directory session-dir))
         (metadata (list :session-id session-id
                        :created timestamp
                        :type "subagent"
                        :parent-session-id parent-session-id
                        :agent_type agent_type
                        :prompt-preview (substring prompt 0 (min 100 (length prompt))))))
    (jf/gptel--write-metadata session-dir metadata)
    (jf/gptel--log 'info "Created subagent metadata with parent link: %s" parent-session-id)
    metadata))
#+end_src

** Create Parent Buffer Status Overlay

#+begin_src emacs-lisp
(defun jf/gptel--create-agent-status-overlay (marker agent-type message)
  "Create a status overlay at MARKER showing agent AGENT-TYPE is working.
MESSAGE describes what the agent is doing."
  (when (and marker (marker-buffer marker))
    (with-current-buffer (marker-buffer marker)
      (save-excursion
        (goto-char marker)
        ;; Handle edge cases - need a line to attach overlay to
        (when (bobp) (insert "\n") (backward-char 1))
        (let* ((line-start (line-beginning-position))
               (line-end (line-end-position))
               (ov (make-overlay line-start line-end nil t)))
          (overlay-put ov 'gptel-agent-status t)
          (overlay-put ov 'evaporate t)
          (overlay-put ov 'after-string
                       (propertize (format "\n[%s: %s]\n"
                                          (capitalize agent-type)
                                          message)
                                  'face '(:foreground "orange" :weight bold)))
          (jf/gptel--log 'debug "Created status overlay for %s" agent-type)
          ov)))))
#+end_src

* VisibleAgent Tool Function
:PROPERTIES:
:header-args:emacs-lisp: :tangle visible-agent.el
:END:

#+begin_src emacs-lisp
(defun jf/gptel-visible-agent-execute (main-cb agent_type prompt &optional visible-p)
  "Execute AGENT_TYPE subagent with PROMPT in a persistent session buffer."
  (interactive
   (list nil
         (completing-read "Agent type: "
                         (mapcar #'car gptel-agent--agents)
                         nil t)
         (read-string "Task prompt: ")
         t))

  ;; Require persistent session
  (unless (and (boundp 'jf/gptel--session-dir) jf/gptel--session-dir)
    (user-error "VisibleAgent can only be called from within a persistent session"))

  (let* ((parent-session-id (or jf/gptel--session-id
                               (jf/gptel--session-id-from-directory jf/gptel--session-dir)))
         (parent-dir jf/gptel--session-dir)
         (slug (jf/gptel--visible-agent-generate-slug agent_type prompt))
         (session-dir (jf/gptel--visible-agent-create-directory parent-dir slug))
         (session-file (jf/gptel--context-file-path session-dir))
         (buffer-name (format "*gptel-agent: %s*" slug))
         (session-buffer (get-buffer-create buffer-name))
         (agent-config (alist-get agent_type gptel-agent--agents nil nil #'equal))
         (parent-marker
          (when-let* ((parent-fsm gptel--fsm-last)
                     (parent-info (gptel-fsm-info parent-fsm)))
            (or (plist-get parent-info :tracking-marker)
                (plist-get parent-info :position))))
         (status-overlay nil))

    (unless agent-config
      (user-error "Agent configuration not found for type: %s" agent_type))

    ;; Create metadata with parent linking
    (jf/gptel--visible-agent-create-metadata session-dir parent-session-id agent_type prompt)

    ;; Create scope plan
    (let ((scope-yaml (jf/gptel--generate-scope-plan-yaml slug "permissive"))
          (scope-file (expand-file-name "scope-plan.yml" session-dir)))
      (with-temp-file scope-file
        (insert scope-yaml))
      (jf/gptel--log 'info "Created permissive scope plan for subagent"))

    ;; Create preset file
    (let ((preset-plist (jf/gptel--generate-preset-plist
                         slug
                         gptel-backend
                         gptel-model)))
      (jf/gptel--write-preset-file session-dir preset-plist)

      ;; Initialize session buffer
      (with-current-buffer session-buffer
        (markdown-mode)
        (unless gptel-mode (gptel-mode 1))
        (jf/gptel--apply-session-preset preset-plist)
        (setq-local jf/gptel--session-id (jf/gptel--session-id-from-directory session-dir))
        (setq-local jf/gptel--session-dir session-dir)
        (setq-local jf/gptel-autosave-enabled t)

        (when-let ((system-msg (plist-get agent-config :system)))
          (insert "<!-- Agent System Prompt -->\n" system-msg "\n\n"))
        (insert (format "# %s Agent Task\n\n" agent_type))
        (insert (format "**Created:** %s\n\n" (format-time-string "%Y-%m-%d %H:%M:%S")))
        (insert "## Task\n\n" prompt "\n\n## Agent Response\n\n")

        (let ((response-start (point))
              (accumulated-response ""))

          (write-file session-file)

          (let ((metadata (jf/gptel--load-metadata-from-file session-dir)))
            (jf/gptel--register-session session-dir metadata session-buffer
                                       (jf/gptel--session-id-from-directory session-dir)))

          (jf/gptel--log 'info "Initialized agent session buffer: %s" buffer-name)

          (unless visible-p
            (setq status-overlay
                  (jf/gptel--create-agent-status-overlay
                   parent-marker agent_type
                   (format "Running %s agent..." agent_type))))

          (gptel-with-preset
              (nconc (list :use-tools t
                           :use-context nil
                           :include-reasoning nil)
                     agent-config)

            (gptel-request prompt
              :position response-start
              :callback
              (lambda (response info)
                (pcase response
                  ('nil
                   (when status-overlay (delete-overlay status-overlay))
                   (jf/gptel--log 'error "Subagent %s failed: %S"
                                 agent_type (plist-get info :error))
                   (when main-cb
                     (funcall main-cb
                              (format "Error: Subagent %s failed. Error: %S"
                                      agent_type (plist-get info :error)))))

                  ((pred stringp)
                   ;; Accumulate response chunks
                   (setq accumulated-response (concat accumulated-response response))
                   ;; Return only when complete (no pending tool use)
                   (unless (plist-get info :tool-use)
                     (when status-overlay (delete-overlay status-overlay))
                     (with-current-buffer session-buffer (save-buffer))
                     (jf/gptel--log 'info "Subagent %s completed" agent_type)
                     (when main-cb
                       (funcall main-cb
                                (format "%s Agent result:\n\n%s\n\nFull session: %s"
                                        (capitalize agent_type)
                                        accumulated-response
                                        session-file)))))

                  ('abort
                   ;; User aborted - cleanup and report
                   (when status-overlay (delete-overlay status-overlay))
                   (jf/gptel--log 'warn "Subagent %s aborted by user" agent_type)
                   (when main-cb
                     (funcall main-cb
                              (format "Error: Subagent %s was aborted by user"
                                      agent_type))))))))

    (when (or visible-p (called-interactively-p 'interactive))
      (pop-to-buffer session-buffer))

    (unless main-cb
      (format "Created agent session: %s\nSession file: %s"
              buffer-name session-file))))
#+end_src

* Tool Registration
:PROPERTIES:
:header-args:emacs-lisp: :tangle visible-agent.el
:END:

#+begin_src emacs-lisp
(with-eval-after-load 'gptel
  ;; Generate enum dynamically from loaded agents
  (let ((available-agents (vconcat (mapcar #'car gptel-agent--agents))))
    (gptel-make-tool
     :name "VisibleAgent"
     :description "Execute specialized agent with persistent session tracking. \
Creates a session buffer that auto-saves and can be reopened. \
By default runs invisibly with status shown in parent buffer. \
Use visible=true to watch agent work in real-time."
     :function #'jf/gptel-visible-agent-execute
     :args `(( :name "agent_type"
              :type string
              :enum ,available-agents
              :description "Type of agent to execute (e.g., researcher, executor, introspector)")
             ( :name "prompt"
              :type string
              :description "Task description and instructions for the agent")
             ( :name "visible"
              :type boolean
              :optional t
              :description "Whether to show agent buffer while running (default: false)"))
     :category "agent"
     :async t
     :confirm t   ; Require user confirmation
     :include t)  ; Include results in parent buffer

    (jf/gptel--log 'info "Registered VisibleAgent tool with %d agents: %S"
                   (length available-agents) available-agents)))
#+end_src

* Provide Feature
:PROPERTIES:
:header-args:emacs-lisp: :tangle visible-agent.el
:END:

#+begin_src emacs-lisp
(provide 'gptel-visible-agent)
;;; visible-agent.el ends here
#+end_src
