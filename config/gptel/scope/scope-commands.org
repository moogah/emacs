#+title: GPTEL Scope Manager - User Commands
#+author: Jeff Farr
#+property: header-args:elisp :tangle scope-commands.el :comments both

* Overview

This module provides user-facing interactive commands for managing v2.0 scope plans. Scope plans use tool-level permissions (read_file, write_file_in_scope, edit_file_in_scope, etc.) rather than category-based permissions.

** Available Commands

1. =jf/gptel-scope-init-plan= - Create new v2.0 scope plan from template
2. =jf/gptel-scope-edit-plan= - Open existing plan for editing

** Plan Templates (v2.0 Format)

All templates now use v2.0 tool-level format with independent configuration per tool:

- *deny-all*: Secure default, only read_file allowed with =/**= pattern (recommended for new sessions)
- *codebase-read*: Read-only exploration (read_file + safe shell commands, no write operations)
- *org-roam-safe*: Read + write/edit org-roam files in gptel/ subdirectory only
- *permissive*: Broad filesystem and shell access for trusted workflows (use with caution)
- *project-aware*: Git-safe defaults scoped to selected projectile projects only (read/write within projects, edit only git-tracked files, blocks .git/.env/runtime/node_modules)

Each template grants read_file permissive =/**= access to any file (except .env, .git, runtime).

* Dependencies

#+begin_src elisp
(require 'cl-lib)
(require 'jf-gptel-scope-core)
#+end_src

* Plan Templates

** Deny-All Template (Secure Default)

Nothing allowed by default. User must explicitly add patterns.

#+begin_src elisp
(defun jf/gptel-scope--template-deny-all (session-id)
  "Secure default template - nothing allowed, user must add patterns.
Recommended for new sessions where you want explicit control."
  (format "version: \"2.0\"
session_id: \"%s\"
created: \"%s\"
updated: \"%s\"
default_policy: deny

tools:
  read_file:
    allowed: true
    patterns:
      - \"/**\"
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"
      - \"**/.env\"

  write_file_in_scope:
    allowed: false
    patterns:
      []
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"
      - \"**/node_modules/**\"
      - \"**/.env\"

  edit_file_in_scope:
    allowed: false
    patterns:
      []
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"
      - \"**/node_modules/**\"
      - \"**/.env\"

  create_roam_node_in_scope:
    allowed: false
    patterns:
      []
    deny_patterns:
      []

  add_roam_tags_in_scope:
    allowed: false
    patterns:
      []
    deny_patterns:
      []

  link_roam_nodes_in_scope:
    allowed: false
    patterns:
      []
    deny_patterns:
      []

  run_approved_command:
    allowed: false
    patterns:
      []
    deny_patterns:
      - \"rm -rf\"
      - \"sudo\"
      - \"chmod\"
      - \"chown\"

"
          session-id
          (format-time-string "%Y-%m-%dT%H:%M:%SZ")
          (format-time-string "%Y-%m-%dT%H:%M:%SZ")))
#+end_src

** Codebase Read Template

Read operations allowed, limited safe shell commands for exploration.

#+begin_src elisp
(defun jf/gptel-scope--template-codebase-read (session-id)
  "Read-only exploration template.
Allows safe shell commands for code exploration (ls, find, grep, git log).
No write operations allowed - LLM must request permission."
  (format "version: \"2.0\"
session_id: \"%s\"
created: \"%s\"
updated: \"%s\"
default_policy: deny

tools:
  read_file:
    allowed: true
    patterns:
      - \"/**\"
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"
      - \"**/.env\"

  write_file_in_scope:
    allowed: false
    patterns:
      []
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"
      - \"**/node_modules/**\"
      - \"**/.env\"

  edit_file_in_scope:
    allowed: false
    patterns:
      []
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"
      - \"**/node_modules/**\"
      - \"**/.env\"

  create_roam_node_in_scope:
    allowed: false
    patterns:
      []
    deny_patterns:
      []

  add_roam_tags_in_scope:
    allowed: false
    patterns:
      []
    deny_patterns:
      []

  link_roam_nodes_in_scope:
    allowed: false
    patterns:
      []
    deny_patterns:
      []

  run_approved_command:
    allowed: true
    patterns:
      - \"ls\"
      - \"find\"
      - \"grep\"
      - \"git\"
      - \"cat\"
      - \"head\"
      - \"tail\"
    deny_patterns:
      - \"rm\"
      - \"sudo\"
      - \"chmod\"
      - \"chown\"
      - \"mv\"
      - \"cp\"

"
          session-id
          (format-time-string "%Y-%m-%dT%H:%M:%SZ")
          (format-time-string "%Y-%m-%dT%H:%M:%SZ")))
#+end_src

** Org-Roam Safe Template

Allow org-roam operations in gptel/ subdirectory with gptel tag.

#+begin_src elisp
(defun jf/gptel-scope--template-org-roam-safe (session-id)
  "Org-roam safe template.
Allows creating and linking nodes in gptel/ subdirectory with gptel tag.
Safe for LLM-generated notes that are clearly separated from personal notes."
  (format "version: \"2.0\"
session_id: \"%s\"
created: \"%s\"
updated: \"%s\"
default_policy: deny

tools:
  read_file:
    allowed: true
    patterns:
      - \"/**\"
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"
      - \"**/.env\"

  write_file_in_scope:
    allowed: true
    patterns:
      - \"%s/gptel/**/*.org\"
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"

  edit_file_in_scope:
    allowed: true
    patterns:
      - \"%s/gptel/**/*.org\"
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"

  create_roam_node_in_scope:
    allowed: true
    patterns:
      - \"subdirectory:gptel/**\"
      - \"tag:gptel\"
    deny_patterns:
      []

  add_roam_tags_in_scope:
    allowed: true
    patterns:
      - \"tag:gptel\"
    deny_patterns:
      []

  link_roam_nodes_in_scope:
    allowed: true
    patterns:
      - \"node_id:*\"
    deny_patterns:
      []

  run_approved_command:
    allowed: true
    patterns:
      - \"ls\"
      - \"find\"
      - \"grep\"
    deny_patterns:
      - \"rm\"
      - \"sudo\"

"
          session-id
          (format-time-string "%Y-%m-%dT%H:%M:%SZ")
          (format-time-string "%Y-%m-%dT%H:%M:%SZ")
          org-roam-directory
          org-roam-directory))
#+end_src

** Permissive Template

Broad access for trusted workflows. Use with caution.

#+begin_src elisp
(defun jf/gptel-scope--template-permissive (session-id)
  "Permissive template - broad access.
USE WITH CAUTION: Allows wide filesystem access and many shell commands.
Only use when you trust the LLM workflow and want minimal restrictions."
  (let ((project-root (or (projectile-project-root) default-directory)))
    (format "version: \"2.0\"
session_id: \"%s\"
created: \"%s\"
updated: \"%s\"
default_policy: deny

tools:
  read_file:
    allowed: true
    patterns:
      - \"/**\"
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"
      - \"**/.env\"

  write_file_in_scope:
    allowed: true
    patterns:
      - \"%s/**\"
      - \"/tmp/**\"
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"
      - \"**/node_modules/**\"
      - \"**/.env\"

  edit_file_in_scope:
    allowed: true
    patterns:
      - \"%s/**\"
      - \"/tmp/**\"
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"
      - \"**/node_modules/**\"
      - \"**/.env\"

  create_roam_node_in_scope:
    allowed: true
    patterns:
      - \"subdirectory:**\"
      - \"tag:*\"
    deny_patterns:
      []

  add_roam_tags_in_scope:
    allowed: true
    patterns:
      - \"tag:*\"
    deny_patterns:
      []

  link_roam_nodes_in_scope:
    allowed: true
    patterns:
      - \"node_id:*\"
    deny_patterns:
      []

  run_approved_command:
    allowed: true
    patterns:
      - \"ls\"
      - \"find\"
      - \"grep\"
      - \"git\"
      - \"cat\"
      - \"head\"
      - \"tail\"
      - \"npm\"
      - \"node\"
      - \"python\"
    deny_patterns:
      - \"rm -rf\"
      - \"sudo\"

"
            session-id
            (format-time-string "%Y-%m-%dT%H:%M:%SZ")
            (format-time-string "%Y-%m-%dT%H:%M:%SZ")
            project-root
            project-root)))
#+end_src

** Project-Aware Template

Allows read/write/edit within selected projectile projects with git-safe defaults.

#+begin_src elisp
(defun jf/gptel-scope--template-project-aware (session-id project-roots)
  "Project-aware scope template.
Allows read/write/edit operations within PROJECT-ROOTS only.
Blocks sensitive paths (.git, .env, runtime, node_modules).

PROJECT-ROOTS is a list of absolute project directory paths.
This is 'git-safe':
- READ: Only files within selected project directories
- WRITE: New files anywhere in project patterns
- EDIT: Only git-tracked files (enforced by edit_file_in_scope tool)

The git-tracked requirement for editing prevents accidental modification
of ignored files like node_modules/, build artifacts, etc."
  (let ((project-patterns (jf/gptel--format-project-patterns project-roots)))
    (format "version: \"2.0\"
session_id: \"%s\"
created: \"%s\"
updated: \"%s\"
default_policy: deny

# This scope plan grants access to %d project(s):
%s

tools:
  read_file:
    allowed: true
    patterns:%s
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"
      - \"**/.env\"
      - \"**/node_modules/**\"

  write_file_in_scope:
    allowed: true
    patterns:%s
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"
      - \"**/.env\"
      - \"**/node_modules/**\"

  edit_file_in_scope:
    allowed: true
    patterns:%s
    deny_patterns:
      - \"**/.git/**\"
      - \"**/runtime/**\"
      - \"**/.env\"
      - \"**/node_modules/**\"

  create_roam_node_in_scope:
    allowed: false
    patterns:
      []
    deny_patterns:
      []

  add_roam_tags_in_scope:
    allowed: false
    patterns:
      []
    deny_patterns:
      []

  link_roam_nodes_in_scope:
    allowed: false
    patterns:
      []
    deny_patterns:
      []

  run_approved_command:
    allowed: true
    patterns:
      - \"ls\"
      - \"find\"
      - \"grep\"
      - \"git\"
    deny_patterns:
      - \"rm -rf\"
      - \"sudo\"
      - \"chmod\"
      - \"chown\"

"
            session-id
            (format-time-string "%Y-%m-%dT%H:%M:%SZ")
            (format-time-string "%Y-%m-%dT%H:%M:%SZ")
            (length project-roots)
            (mapconcat (lambda (root)
                        (format "#   - %s (%s)"
                               root
                               (jf/gptel--project-display-name root)))
                      project-roots
                      "\n")
            project-patterns  ; read_file patterns
            project-patterns  ; write_file_in_scope patterns
            project-patterns)))  ; edit_file_in_scope patterns
#+end_src

* Helper Functions

** Project Selection

Interactive selection of 0 or more projectile projects.

#+begin_src elisp
(defun jf/gptel--select-projects ()
  "Interactively select 0 or more projectile projects.
Returns list of absolute project root paths."
  (let ((projects (projectile-known-projects)))
    (if (null projects)
        (progn
          (message "No known projectile projects found")
          nil)
      (let* ((selection (completing-read-multiple
                        "Select projects (RET when done): "
                        projects
                        nil t)))
        (when selection
          (mapcar #'expand-file-name selection))))))
#+end_src

** Project Display Name

Extract display name from project root path.

#+begin_src elisp
(defun jf/gptel--project-display-name (project-root)
  "Extract display name from PROJECT-ROOT path.
Uses projectile-project-name if available, else basename."
  (condition-case nil
      (let ((default-directory project-root))
        (projectile-project-name))
    (error (file-name-nondirectory (directory-file-name project-root)))))
#+end_src

** Format Project Patterns

Format project roots as YAML pattern list for scope plans.

#+begin_src elisp
(defun jf/gptel--format-project-patterns (project-roots)
  "Format PROJECT-ROOTS as YAML pattern list.
Returns indented YAML list string like:
      - \"/path/to/project1/**\"
      - \"/path/to/project2/**\""
  (if (null project-roots)
      "[]"
    (concat "\n"
            (mapconcat (lambda (root)
                        (format "      - \"%s/**\""
                               (directory-file-name root)))
                      project-roots
                      "\n"))))
#+end_src

** Generate Scope Plan YAML

Helper function to generate scope plan YAML string without user interaction.
Used for auto-initialization and programmatic plan creation.

#+begin_src elisp
(defun jf/gptel--generate-scope-plan-yaml (session-id &optional template &rest args)
  "Generate scope plan YAML for SESSION-ID using TEMPLATE.
TEMPLATE can be deny-all, codebase-read, org-roam-safe, permissive, or project-aware.
ARGS are passed to template function (e.g., project-roots for project-aware).
Defaults to deny-all.

This is an internal helper used for auto-initialization of session scope plans.
Returns YAML string directly without writing to file."
  (let* ((template (or template "deny-all"))
         (template-fn (intern (format "jf/gptel-scope--template-%s" template))))
    (unless (fboundp template-fn)
      (error "Unknown scope template: %s" template))
    (apply template-fn session-id args)))
#+end_src

* Interactive Commands

** Initialize Scope Plan

Create new scope plan for current gptel session.

#+begin_src elisp
(defun jf/gptel-scope-init-plan (&optional template)
  "Create scope plan for current gptel session.
Requires being in gptel buffer, auto-initializes session if needed.

TEMPLATE: Symbol for template to use
         (deny-all, codebase-read, org-roam-safe, permissive, project-aware)
         If nil, prompts user to select template."
  (interactive
   (list (intern (completing-read "Template: "
                                  '("deny-all" "codebase-read" "org-roam-safe"
                                    "permissive" "project-aware")
                                  nil t nil nil "deny-all"))))
  (unless gptel-mode
    (user-error "Not in a gptel buffer. Start one with M-x gptel first"))

  ;; Auto-initialize session if needed
  (when (and (not jf/gptel--session-id) jf/gptel-autosave-enabled)
    (message "Initializing new session...")
    (jf/gptel--initialize-session))

  (unless jf/gptel--session-id
    (user-error "No session ID. Enable autosave with M-x jf/gptel-toggle-autosave"))

  (let* ((session-id jf/gptel--session-id)
         (session-data (jf/gptel--get-session-data session-id))
         (session-dir (plist-get session-data :directory))
         (plan-file (expand-file-name "scope-plan.yml" session-dir))
         (template-fn (intern (format "jf/gptel-scope--template-%s" template)))
         ;; For project-aware, prompt for projects
         (template-args (when (eq template 'project-aware)
                         (list (jf/gptel--select-projects))))
         (plan-content (apply template-fn session-id template-args)))

    ;; Check if plan already exists
    (when (file-exists-p plan-file)
      (unless (yes-or-no-p "Scope plan already exists. Overwrite? ")
        (user-error "Cancelled")))

    ;; Write plan file
    (with-temp-file plan-file
      (insert plan-content))

    ;; Open for editing
    (find-file plan-file)
    (message "Scope plan created: %s (Edit and save to customize)" plan-file)))
#+end_src

** Edit Scope Plan

Open existing scope plan for editing.

#+begin_src elisp
(defun jf/gptel-scope-edit-plan (&optional session-id)
  "Open scope plan in editor.
Works from anywhere - prompts for session if not in gptel buffer.

SESSION-ID: Optional session ID. If nil, uses current session or prompts."
  (interactive)
  (let* ((session-id (or session-id
                        (and (boundp 'jf/gptel--session-id) jf/gptel--session-id)
                        (let ((sessions (jf/gptel--list-all-sessions)))
                          (when sessions
                            (completing-read "Select session: " sessions nil t)))))
         (session-data (when session-id (jf/gptel--get-session-data session-id)))
         (session-dir (when session-data (plist-get session-data :directory)))
         (plan-file (when session-dir (expand-file-name "scope-plan.yml" session-dir))))

    (unless session-id
      (user-error "No session selected or found"))

    (unless (file-exists-p plan-file)
      (if (yes-or-no-p (format "No plan found for session %s. Create one? " session-id))
          (let* ((template (intern (completing-read "Template: "
                                                   '("deny-all" "codebase-read" "org-roam-safe"
                                                     "permissive" "project-aware")
                                                   nil t nil nil "deny-all")))
                 (template-args (when (eq template 'project-aware)
                                 (list (jf/gptel--select-projects)))))
            (with-temp-file plan-file
              (insert (apply (intern (format "jf/gptel-scope--template-%s" template))
                           session-id template-args)))
            (find-file plan-file)
            (message "Scope plan created: %s" plan-file))
        (user-error "Cancelled")))

    (find-file plan-file)))
#+end_src

** List Session Helpers (For Completion)

Helper functions to list sessions for command completion.

#+begin_src elisp
(defun jf/gptel--list-all-sessions ()
  "List all gptel session IDs (active and archived).
Returns list of session ID strings."
  (let ((session-dir (expand-file-name "~/gptel-sessions"))
        (sessions nil))
    (when (file-directory-p session-dir)
      (dolist (entry (directory-files session-dir nil "^[0-9]\\{4\\}-[0-9]\\{2\\}-[0-9]\\{2\\}"))
        (when (file-directory-p (expand-file-name entry session-dir))
          (push entry sessions))))
    (nreverse sessions)))
#+end_src

* Provide Feature

#+begin_src elisp
(provide 'jf-gptel-scope-commands)
;;; scope-commands.el ends here
#+end_src
