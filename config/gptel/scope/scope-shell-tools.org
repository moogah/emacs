#+title: GPTEL Scope Manager - Shell and Meta Tools
#+author: Jeff Farr
#+property: header-args:elisp :tangle scope-shell-tools.el :comments both

* Overview

This module provides scope-aware shell execution and meta tools for v3.0 preset-based permission management:

1. *Shell tool*: =run_approved_command= - Execute shell commands with pattern checking (v3.0)
2. *Meta tool*: =request_scope_expansion= - LLM requests user approval via transient menu (v3.0 async)

** Shell Command Scoping (v3.0)

The =run_approved_command= tool uses preset.md configuration:
- *shell_commands.allow*: Allowlist of command names (e.g., ["ls", "git", "npm"])
- *shell_commands.deny*: Denylist patterns (substring matching, e.g., ["rm -rf", "sudo"])

Deny patterns override allow patterns for security.
Validation handled by =jf/gptel-scope--validate-command-tool= in scope-core.org.

** Scope Expansion (v3.0)

The =request_scope_expansion= tool shows interactive transient menu with 3 choices:
- *Deny* - Reject the expansion request
- *Add to scope* - Permanently add patterns to preset.md
- *Allow once* - Temporarily allow for current turn only

Uses async tool pattern with callback for FSM coordination.
UI implemented in scope-expansion.org.

* File Header

#+begin_src elisp
;;; scope-shell-tools.el --- GPTEL Scope Shell and Meta Tools -*- lexical-binding: t; -*-

;; Copyright (C) 2024-2026 Jeff Farr

;;; Commentary:

;; Scope-aware shell execution and meta tools for v3.0 preset-based permission management.

;;; Code:
#+end_src

* Dependencies

#+begin_src elisp
(require 'cl-lib)
(require 'jf-gptel-scope-core)
(require 'jf-gptel-scope-expansion)  ; For jf/gptel-scope--prompt-expansion
#+end_src

* Run Approved Command Tool (Scope-Aware, v3.0)

Execute shell command if allowed by scope plan using v3.0 scoped-tool macro.

#+begin_src elisp
(gptel-make-scoped-tool
 "run_approved_command"
 "Execute shell command if allowed by scope plan.

Checks command against shell_commands.allow and shell_commands.deny in preset.md.
Allow list: Exact command name match (e.g., 'ls' allows 'ls -la')
Deny list: Substring match (e.g., 'rm -rf' blocks any command containing 'rm -rf')

Deny patterns override allow patterns for security.
Use request_scope_expansion to add commands to allow list."

 (list '(:name "command"
         :type string
         :description "Shell command to execute"))

 "shell"

 ;; Tool body - executed only if validation passes
 (condition-case err
     (let* ((output (with-output-to-string
                     (with-current-buffer standard-output
                       (call-process shell-file-name nil t nil
                                   shell-command-switch command))))
            (exit-code 0))  ; Simplified - proper exit code requires process handle
       (list :success t
             :output output
             :exit_code exit-code
             :message "Command executed"))
   (error
    (list :success nil
          :error "command_failed"
          :message (format "Command execution failed: %s" (error-message-string err))))))
#+end_src

* Request Scope Expansion Tool (Meta Tool, v3.0 Async)

LLM uses this tool to explicitly request user approval for expanding scope using transient menu.

#+begin_src elisp
(gptel-make-tool
 :name "request_scope_expansion"
 :async t  ; MUST be async for transient menu
 :description "Request user approval to expand scope with new patterns.

Displays interactive menu with 3 options:
1. Deny - Reject the expansion request
2. Add to scope - Permanently add patterns to preset.md
3. Allow once - Temporarily allow for current turn only

The user will see:
- Which tool needs access
- What patterns/resources you want to add
- Your justification for why access is needed

Returns:
- success: true if approved (add-to-scope or allow-once)
- success: false if denied
- allowed_once: true if temporary permission granted
- patterns_added: list of patterns if permanently added"
 :args (list '(:name "tool_name"
               :type string
               :description "Tool name (e.g., 'read_file', 'write_file_in_scope', 'run_approved_command')")
             '(:name "patterns"
               :type array
               :items (:type string)
               :description "Patterns to add (e.g., [\"/tmp/**\"] for files, [\"npm\"] for shell)")
             '(:name "justification"
               :type string
               :description "Explain why this access is needed. Be specific."))
 :category "scope"
 :function
 (lambda (callback tool_name patterns justification)  ; callback first!
   ;; Convert patterns from vector to list
   (when (vectorp patterns)
     (setq patterns (append patterns nil)))

   ;; Build violation info for transient menu
   (let* ((violation-info
           (list :tool tool_name
                 :resource (car patterns)  ; First pattern as resource
                 :reason justification
                 :validation-type (jf/gptel-scope--infer-validation-type tool_name)
                 :patterns patterns)))

     ;; Show transient menu - pass callback, patterns, tool_name directly in scope
     (jf/gptel-scope--prompt-expansion violation-info callback patterns tool_name))))
#+end_src

* Helper: Infer Validation Type

Helper to infer validation type from tool name using tool categories.

#+begin_src elisp
(defun jf/gptel-scope--infer-validation-type (tool-name)
  "Infer validation type from TOOL-NAME using tool categories."
  (let ((category (cdr (assoc tool-name jf/gptel-scope--tool-categories))))
    (plist-get category :validation)))
#+end_src

* Obsolete: inspect_scope_plan Tool (Removed in v3.0)

In v3.0, preset.md is a readable markdown file with YAML frontmatter.
LLM can use read_file("preset.md") to inspect scope configuration directly.
No dedicated inspection tool needed.

* Provide Feature

#+begin_src elisp
(provide 'jf-gptel-scope-shell-tools)
;;; scope-shell-tools.el ends here
#+end_src
