#+title: GPTEL Session Filesystem Utilities
#+author: Jeff Farr
#+property: header-args:emacs-lisp :tangle filesystem.el
#+auto_tangle: y

* Introduction

Filesystem utilities for directory-based gptel session persistence.
Provides functions for creating, managing, and navigating session directories.

* Lexical Binding

#+begin_src emacs-lisp
;;; filesystem.el --- GPTEL Session Filesystem Utilities -*- lexical-binding: t; -*-

;; Copyright (C) 2024-2026 Jeff Farr

;;; Commentary:

;; Filesystem utilities for gptel session management.
;; Handles directory creation, file path resolution, and session discovery.

;;; Code:

(require 'cl-lib)
(require 'gptel-session-constants)
(require 'gptel-session-logging)
#+end_src

* Session Directory Creation

#+begin_src emacs-lisp
(defun jf/gptel--ensure-sessions-root ()
  "Ensure the root sessions directory exists.
Creates jf/gptel-sessions-directory if it doesn't exist.
Returns the absolute path to the sessions directory."
  (let ((dir (expand-file-name jf/gptel-sessions-directory)))
    (unless (file-directory-p dir)
      (make-directory dir t)
      (jf/gptel--log 'info "Created sessions directory: %s" dir))
    dir))

(defun jf/gptel--create-session-directory (session-id)
  "Create directory for SESSION-ID.
Returns the absolute path to the created directory."
  (let* ((root (jf/gptel--ensure-sessions-root))
         (session-dir (expand-file-name session-id root)))
    (if (file-directory-p session-dir)
        (progn
          (jf/gptel--log 'warn "Session directory already exists: %s" session-dir)
          session-dir)
      (make-directory session-dir t)
      (jf/gptel--log 'info "Created session directory: %s" session-dir)
      session-dir)))
#+end_src

* Session ID Generation

#+begin_src emacs-lisp
(defun jf/gptel--generate-session-id (base-name)
  "Generate unique session ID from BASE-NAME.
Format: <slugified-base-name>-<timestamp>
Example: 'react-refactoring-20260120153042'"
  (let* ((slug (replace-regexp-in-string "[^a-z0-9-]" "-"
                                        (downcase base-name)))
         (timestamp (format-time-string "%Y%m%d%H%M%S")))
    (format "%s-%s" slug timestamp)))

(defun jf/gptel--session-id-from-directory (session-dir)
  "Extract session ID from SESSION-DIR path.
Returns the directory name (last path component)."
  (file-name-nondirectory (directory-file-name session-dir)))
#+end_src

* Path Resolution

#+begin_src emacs-lisp
(defun jf/gptel--session-file-path (session-dir filename)
  "Get absolute path to FILENAME in SESSION-DIR.
Does not check if file exists."
  (expand-file-name filename session-dir))

(defun jf/gptel--context-file-path (session-dir)
  "Get path to context file in SESSION-DIR."
  (jf/gptel--session-file-path session-dir jf/gptel-session--context-file))

(defun jf/gptel--scope-plan-file-path (session-dir)
  "Get path to scope-plan.yml file in SESSION-DIR."
  (expand-file-name "scope-plan.yml" session-dir))

(defun jf/gptel--tools-log-path (session-dir)
  "Get path to tools log file in SESSION-DIR."
  (jf/gptel--session-file-path session-dir jf/gptel-session--tools-log-file))

(defun jf/gptel--system-prompts-log-path (session-dir)
  "Get path to system prompts log file in SESSION-DIR."
  (jf/gptel--session-file-path session-dir jf/gptel-session--system-prompts-file))

(defun jf/gptel--agents-dir-path (session-dir)
  "Get path to agents directory in SESSION-DIR."
  (jf/gptel--session-file-path session-dir jf/gptel-session--agents-dir))
#+end_src

* Session Discovery

#+begin_src emacs-lisp
(defun jf/gptel--list-session-directories ()
  "List all session directories in jf/gptel-sessions-directory.
Returns list of absolute paths to session directories."
  (let ((root (expand-file-name jf/gptel-sessions-directory)))
    (when (file-directory-p root)
      (seq-filter
       (lambda (path)
         (and (file-directory-p path)
              (not (string-prefix-p "." (file-name-nondirectory path)))))
       (directory-files root t "^[^.]")))))

(defun jf/gptel--find-session-directory (session-id)
  "Find session directory for SESSION-ID.
Returns absolute path if found, nil otherwise."
  (let ((root (expand-file-name jf/gptel-sessions-directory))
        (expected (expand-file-name session-id
                                   (expand-file-name jf/gptel-sessions-directory))))
    (when (file-directory-p expected)
      expected)))
#+end_src

* Recursive Session Discovery

Discover all sessions recursively, including nested agents.

#+begin_src emacs-lisp
(defun jf/gptel--find-all-sessions-recursive (&optional root-dir depth)
  "Find all session directories recursively, including agents.
ROOT-DIR defaults to jf/gptel-sessions-directory.
DEPTH is current nesting level (0 for top-level).

Returns list of plists with:
  :path - Full path to session directory
  :id - Session ID (directory name)
  :depth - Nesting depth (0 for top-level, 1+ for agents)
  :parent-path - Path to parent session (nil for top-level)"
  (let ((root (or root-dir (expand-file-name jf/gptel-sessions-directory)))
        (current-depth (or depth 0))
        (sessions nil))
    (when (file-directory-p root)
      ;; Find direct subdirectories
      (dolist (entry (directory-files root t "^[^.]"))
        (when (and (file-directory-p entry)
                  (jf/gptel--valid-session-directory-p entry))
          ;; Add this session
          (push (list :path entry
                     :id (jf/gptel--session-id-from-directory entry)
                     :depth current-depth
                     :parent-path (when (> current-depth 0) root))
               sessions)
          ;; Recursively find agents
          (let ((agents-dir (jf/gptel--agents-dir-path entry)))
            (when (file-directory-p agents-dir)
              (setq sessions
                   (append sessions
                          (jf/gptel--find-all-sessions-recursive
                           agents-dir
                           (1+ current-depth)))))))))
    (nreverse sessions)))
#+end_src

* Agent Directories

#+begin_src emacs-lisp
(defun jf/gptel--create-agent-directory (parent-session-dir preset description)
  "Create agent directory under PARENT-SESSION-DIR.
PRESET is the preset name (e.g., 'researcher', 'executor').
DESCRIPTION is a brief description for the directory name.
Returns the absolute path to the created agent directory."
  (let* ((agents-dir (jf/gptel--agents-dir-path parent-session-dir))
         (slug (replace-regexp-in-string "[^a-z0-9-]" "-"
                                        (downcase description)))
         (timestamp (format-time-string "%Y%m%d%H%M%S"))
         (dirname (format "%s-%s-%s" preset timestamp slug))
         (agent-dir (expand-file-name dirname agents-dir)))
    ;; Create agents directory if needed
    (unless (file-directory-p agents-dir)
      (make-directory agents-dir t))
    ;; Create agent session directory
    (make-directory agent-dir t)
    (jf/gptel--log 'info "Created agent directory: %s" agent-dir)
    agent-dir))

(defun jf/gptel--list-agent-directories (parent-session-dir)
  "List all agent directories under PARENT-SESSION-DIR.
Returns list of absolute paths."
  (let ((agents-dir (jf/gptel--agents-dir-path parent-session-dir)))
    (when (file-directory-p agents-dir)
      (seq-filter
       #'file-directory-p
       (directory-files agents-dir t "^[^.]")))))
#+end_src

* Validation

#+begin_src emacs-lisp
(defun jf/gptel--valid-session-directory-p (dir)
  "Return t if DIR is a valid session directory.
Checks for existence and presence of scope-plan.yml file."
  (and (file-directory-p dir)
       (file-exists-p (jf/gptel--scope-plan-file-path dir))))
#+end_src

* Provide Feature

#+begin_src emacs-lisp
(provide 'gptel-session-filesystem)
;;; filesystem.el ends here
#+end_src
