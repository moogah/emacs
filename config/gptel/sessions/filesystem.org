#+title: GPTEL Session Filesystem Utilities
#+author: Jeff Farr
#+property: header-args:emacs-lisp :tangle filesystem.el
#+auto_tangle: y

* Introduction

Filesystem utilities for directory-based gptel session persistence.
Provides functions for creating, managing, and navigating session directories.

* Lexical Binding

#+begin_src emacs-lisp
;;; filesystem.el --- GPTEL Session Filesystem Utilities -*- lexical-binding: t; -*-

;; Copyright (C) 2024-2026 Jeff Farr

;;; Commentary:

;; Filesystem utilities for gptel session management.
;; Handles directory creation, file path resolution, and session discovery.

;;; Code:

(require 'cl-lib)
(require 'gptel-session-constants)
(require 'gptel-session-logging)
#+end_src

* Session Directory Creation

#+begin_src emacs-lisp
(defun jf/gptel--ensure-sessions-root ()
  "Ensure the root sessions directory exists.
Creates jf/gptel-sessions-directory if it doesn't exist.
Returns the absolute path to the sessions directory."
  (let ((dir (expand-file-name jf/gptel-sessions-directory)))
    (unless (file-directory-p dir)
      (make-directory dir t)
      (jf/gptel--log 'info "Created sessions directory: %s" dir))
    dir))

(defun jf/gptel--create-session-directory (session-id)
  "Create directory for SESSION-ID.
Returns the absolute path to the created directory."
  (let* ((root (jf/gptel--ensure-sessions-root))
         (session-dir (expand-file-name session-id root)))
    (if (file-directory-p session-dir)
        (progn
          (jf/gptel--log 'warn "Session directory already exists: %s" session-dir)
          session-dir)
      (make-directory session-dir t)
      (jf/gptel--log 'info "Created session directory: %s" session-dir)
      session-dir)))
#+end_src

* Session ID Generation

#+begin_src emacs-lisp
(defun jf/gptel--generate-session-id (base-name)
  "Generate unique session ID from BASE-NAME.
Format: <slugified-base-name>-<timestamp>
Example: 'react-refactoring-20260120153042'"
  (let* ((slug (replace-regexp-in-string "[^a-z0-9-]" "-"
                                        (downcase base-name)))
         (timestamp (format-time-string "%Y%m%d%H%M%S")))
    (format "%s-%s" slug timestamp)))

(defun jf/gptel--session-id-from-directory (session-dir)
  "Extract session ID from SESSION-DIR path.
Returns the directory name (last path component)."
  (file-name-nondirectory (directory-file-name session-dir)))
#+end_src

* Branch Structure Functions

Functions for navigating the new branch-inside-session architecture.

** Branch Directory Paths

#+begin_src emacs-lisp
(defun jf/gptel--branches-dir-path (session-dir)
  "Get path to branches directory in SESSION-DIR."
  (expand-file-name "branches" session-dir))

(defun jf/gptel--branch-dir-path (session-dir branch-name)
  "Get path to specific BRANCH-NAME directory in SESSION-DIR."
  (expand-file-name branch-name (jf/gptel--branches-dir-path session-dir)))

(defun jf/gptel--current-symlink-path (session-dir)
  "Get path to current symlink in SESSION-DIR."
  (expand-file-name "current" session-dir))

(defun jf/gptel--get-current-branch-name (session-dir)
  "Get name of current branch in SESSION-DIR by following symlink.
Returns branch name (e.g., \"main\" or \"20260128153042-feature\") or nil if symlink doesn't exist."
  (let ((symlink (jf/gptel--current-symlink-path session-dir)))
    (when (file-symlink-p symlink)
      (file-name-nondirectory (file-truename symlink)))))

(defun jf/gptel--get-current-branch-dir (session-dir)
  "Get path to current branch directory in SESSION-DIR by following symlink.
Returns absolute path or nil if symlink doesn't exist."
  (let ((symlink (jf/gptel--current-symlink-path session-dir)))
    (when (file-symlink-p symlink)
      (file-truename symlink))))
#+end_src

** Create Branch Directory

#+begin_src emacs-lisp
(defun jf/gptel--create-branch-directory (session-dir branch-name)
  "Create branch directory for BRANCH-NAME in SESSION-DIR.
Returns absolute path to created branch directory."
  (let* ((branches-dir (jf/gptel--branches-dir-path session-dir))
         (branch-dir (expand-file-name branch-name branches-dir)))
    (unless (file-directory-p branches-dir)
      (make-directory branches-dir t))
    (unless (file-directory-p branch-dir)
      (make-directory branch-dir t)
      (jf/gptel--log 'info "Created branch directory: %s" branch-dir))
    branch-dir))
#+end_src

** Update Current Symlink

#+begin_src emacs-lisp
(defun jf/gptel--update-current-symlink (session-dir branch-name)
  "Update current symlink in SESSION-DIR to point to BRANCH-NAME.
Creates or updates the symlink. Returns path to symlink."
  (let* ((symlink (jf/gptel--current-symlink-path session-dir))
         (target (concat "branches/" branch-name)))
    ;; Remove existing symlink if present
    (when (file-exists-p symlink)
      (delete-file symlink))
    ;; Create new symlink (relative path)
    (make-symbolic-link target symlink)
    (jf/gptel--log 'debug "Updated current symlink to: %s" branch-name)
    symlink))
#+end_src

** List Branches

#+begin_src emacs-lisp
(defun jf/gptel--list-branches (session-dir)
  "List all branch names in SESSION-DIR.
Returns list of branch names (e.g., (\"main\" \"20260128153042-feature\"))."
  (let ((branches-dir (jf/gptel--branches-dir-path session-dir)))
    (when (file-directory-p branches-dir)
      (seq-filter
       (lambda (name)
         (and (not (string-prefix-p "." name))
              (file-directory-p (expand-file-name name branches-dir))))
       (directory-files branches-dir nil "^[^.]")))))
#+end_src

* Path Resolution

Branch-aware path resolution functions. All paths now require a branch directory.

#+begin_src emacs-lisp
(defun jf/gptel--branch-file-path (branch-dir filename)
  "Get absolute path to FILENAME in BRANCH-DIR.
Does not check if file exists."
  (expand-file-name filename branch-dir))

(defun jf/gptel--context-file-path (branch-dir)
  "Get path to context file in BRANCH-DIR."
  (jf/gptel--branch-file-path branch-dir jf/gptel-session--context-file))

(defun jf/gptel--branch-metadata-file-path (branch-dir)
  "Get path to branch-metadata.yml file in BRANCH-DIR."
  (expand-file-name "branch-metadata.yml" branch-dir))

(defun jf/gptel--tools-log-path (branch-dir)
  "Get path to tools log file in BRANCH-DIR."
  (jf/gptel--branch-file-path branch-dir jf/gptel-session--tools-log-file))

(defun jf/gptel--system-prompts-log-path (branch-dir)
  "Get path to system prompts log file in BRANCH-DIR."
  (jf/gptel--branch-file-path branch-dir jf/gptel-session--system-prompts-file))

(defun jf/gptel--agents-dir-path (branch-dir)
  "Get path to agents directory in BRANCH-DIR."
  (jf/gptel--branch-file-path branch-dir jf/gptel-session--agents-dir))

(defun jf/gptel--scope-file-path (branch-dir)
  "Get path to scope.yml file in BRANCH-DIR."
  (expand-file-name jf/gptel-session--scope-file branch-dir))

(defun jf/gptel--metadata-file-path (branch-dir)
  "Get path to metadata.yml file in BRANCH-DIR."
  (expand-file-name jf/gptel-session--metadata-file branch-dir))
#+end_src

* Session Discovery

#+begin_src emacs-lisp
(defun jf/gptel--list-session-directories ()
  "List all session directories in jf/gptel-sessions-directory.
Returns list of absolute paths to session directories."
  (let ((root (expand-file-name jf/gptel-sessions-directory)))
    (when (file-directory-p root)
      (seq-filter
       (lambda (path)
         (and (file-directory-p path)
              (not (string-prefix-p "." (file-name-nondirectory path)))))
       (directory-files root t "^[^.]")))))

(defun jf/gptel--find-session-directory (session-id)
  "Find session directory for SESSION-ID.
Returns absolute path if found, nil otherwise."
  (let ((root (expand-file-name jf/gptel-sessions-directory))
        (expected (expand-file-name session-id
                                   (expand-file-name jf/gptel-sessions-directory))))
    (when (file-directory-p expected)
      expected)))
#+end_src

* Branch and Agent Discovery

Discover all branches and agents in the new branch-inside-session architecture.

#+begin_src emacs-lisp
(defun jf/gptel--find-all-branches-with-agents ()
  "Find all branches across all sessions, including their agents.

Returns list of plists with:
  :session-dir - Path to session directory
  :session-id - Session ID
  :branch-dir - Path to branch directory
  :branch-name - Branch name (e.g., \"main\" or \"20260128153042-feature\")
  :agent-dirs - List of agent directory paths in this branch"
  (let ((sessions-root (expand-file-name jf/gptel-sessions-directory))
        (results nil))
    (when (file-directory-p sessions-root)
      ;; Iterate over all session directories
      (dolist (session-dir (directory-files sessions-root t "^[^.]"))
        (when (jf/gptel--valid-session-directory-p session-dir)
          (let ((session-id (jf/gptel--session-id-from-directory session-dir))
                (branches (jf/gptel--list-branches session-dir)))
            ;; Iterate over branches in this session
            (dolist (branch-name branches)
              (let* ((branch-dir (jf/gptel--branch-dir-path session-dir branch-name))
                     (agents-dir (jf/gptel--agents-dir-path branch-dir))
                     (agent-dirs (when (file-directory-p agents-dir)
                                  (jf/gptel--list-agent-directories branch-dir))))
                (push (list :session-dir session-dir
                           :session-id session-id
                           :branch-dir branch-dir
                           :branch-name branch-name
                           :agent-dirs (or agent-dirs nil))
                     results)))))))
    (nreverse results)))
#+end_src

* Agent Directories

Agent directories are now per-branch, not per-session.

#+begin_src emacs-lisp
(defun jf/gptel--create-agent-directory (parent-branch-dir preset description)
  "Create agent directory under PARENT-BRANCH-DIR.
PRESET is the preset name (e.g., 'researcher', 'executor').
DESCRIPTION is a brief description for the directory name.
Returns the absolute path to the created agent directory."
  (let* ((agents-dir (jf/gptel--agents-dir-path parent-branch-dir))
         (slug (replace-regexp-in-string "[^a-z0-9-]" "-"
                                        (downcase description)))
         (timestamp (format-time-string "%Y%m%d%H%M%S"))
         (dirname (format "%s-%s-%s" preset timestamp slug))
         (agent-dir (expand-file-name dirname agents-dir)))
    ;; Create agents directory if needed
    (unless (file-directory-p agents-dir)
      (make-directory agents-dir t))
    ;; Create agent session directory
    (make-directory agent-dir t)
    (jf/gptel--log 'info "Created agent directory: %s" agent-dir)
    agent-dir))

(defun jf/gptel--list-agent-directories (parent-branch-dir)
  "List all agent directories under PARENT-BRANCH-DIR.
Returns list of absolute paths."
  (let ((agents-dir (jf/gptel--agents-dir-path parent-branch-dir)))
    (when (file-directory-p agents-dir)
      (seq-filter
       #'file-directory-p
       (directory-files agents-dir t "^[^.]")))))
#+end_src

* Validation

#+begin_src emacs-lisp
(defun jf/gptel--valid-session-directory-p (dir)
  "Return t if DIR is a valid session directory.
Checks for existence of branches directory."
  (and (file-directory-p dir)
       (file-directory-p (jf/gptel--branches-dir-path dir))))

(defun jf/gptel--valid-branch-directory-p (dir)
  "Return t if DIR is a valid branch directory.
Checks for existence and presence of session.md file."
  (and (file-directory-p dir)
       (file-exists-p (jf/gptel--context-file-path dir))))
#+end_src

* Provide Feature

#+begin_src emacs-lisp
(provide 'gptel-session-filesystem)
;;; filesystem.el ends here
#+end_src
