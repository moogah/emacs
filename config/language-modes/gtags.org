#+title: GTags Configuration
#+author: Jeff Farr
#+property: header-args:emacs-lisp :tangle gtags.el
#+auto_tangle: y

* Introduction
This file configures GTags (GNU Global) integration for Emacs, providing code navigation and indexing capabilities for various programming languages.

The configuration makes tag file management completely transparent:
- Tags are automatically created when switching to a new project
- Tags are automatically updated on file save
- Git hooks automatically update tags on commit
- Clear error messages if GNU Global is not installed

* Basic Configuration
Setup lexical binding for better closures and variable scoping.

#+begin_src emacs-lisp
;; -*- lexical-binding: t; -*-
#+end_src

* Binary Detection and Error Handling
Check if GNU Global binary is available and provide helpful error messages.

#+begin_src emacs-lisp
(defun jf/gtags-check-binary ()
  "Check if global binary is available. Return path or nil."
  (executable-find "global"))
#+end_src

#+begin_src emacs-lisp
(defun jf/gtags-ensure-binary ()
  "Ensure global binary exists, show helpful error if not."
  (unless (jf/gtags-check-binary)
    (display-warning
     'gtags
     (concat "GNU Global (gtags) not found in PATH.\n\n"
             "Install with: brew install global\n\n"
             "ggtags features will be unavailable until installed.")
     :error)
    nil))
#+end_src

* Configuration Variables
Customize GTags behavior via configuration variables.

#+begin_src emacs-lisp
(defgroup jf-gtags nil
  "Customization for JF's gtags configuration."
  :group 'ggtags)
#+end_src

#+begin_src emacs-lisp
(defcustom jf/gtags-auto-create-on-project-switch t
  "When non-nil, automatically create GTAGS on project switch if missing."
  :type 'boolean
  :group 'jf-gtags)
#+end_src

#+begin_src emacs-lisp
(defcustom jf/gtags-create-git-hooks t
  "When non-nil, automatically create git post-commit hooks for tag updates."
  :type 'boolean
  :group 'jf-gtags)
#+end_src

#+begin_src emacs-lisp
(defcustom jf/gtags-enabled-modes
  '(python-mode js-mode typescript-mode go-mode c-mode c++-mode)
  "List of modes where ggtags-mode should be automatically enabled."
  :type '(repeat symbol)
  :group 'jf-gtags)
#+end_src

* Automatic Tag Creation
Automatically create GTAGS database when switching to project without tags.

#+begin_src emacs-lisp
(defun jf/gtags-project-has-source-files-p (directory)
  "Quick check if project has indexable source files."
  (let ((default-directory directory))
    (or (file-expand-wildcards "*.py")
        (file-expand-wildcards "*.js")
        (file-expand-wildcards "*.ts")
        (file-expand-wildcards "*.go")
        (file-expand-wildcards "*.c")
        (file-expand-wildcards "*.cpp"))))
#+end_src

#+begin_src emacs-lisp
(defun jf/gtags-create-tags-async (directory)
  "Create GTAGS database asynchronously in DIRECTORY."
  (let ((default-directory directory)
        (process-name "gtags-create")
        (buffer-name "*gtags-create*"))
    (when (get-process process-name)
      (delete-process process-name))
    (let ((proc (start-process
                 process-name buffer-name
                 "gtags" "--gtagslabel=pygments")))
      (set-process-sentinel
       proc
       (lambda (process event)
         (cond
          ((string-match-p "finished" event)
           (message "GTAGS database created for %s" directory))
          ((string-match-p "exited abnormally" event)
           (display-warning
            'gtags
            (format "Failed to create GTAGS: %s\nCheck *gtags-create* buffer" event)
            :error))))))))
#+end_src

#+begin_src emacs-lisp
(defun jf/gtags-auto-create-if-needed ()
  "Create GTAGS database if project has none. Runs async, non-blocking."
  (when (and (jf/gtags-check-binary)
             (projectile-project-root)
             (not (ggtags-find-project)))
    (let ((project-root (projectile-project-root)))
      (when (jf/gtags-project-has-source-files-p project-root)
        (message "Creating GTAGS database for %s..." project-root)
        (jf/gtags-create-tags-async project-root)))))
#+end_src

* Git Hook Configuration
Set up automatic tag generation on Git commits with enhanced error handling.

#+begin_src emacs-lisp
(defun create-tags-git-hook ()
  "Create git post-commit hook to update GTAGS. Idempotent."
  (when-let ((project-root (projectile-project-root))
             (git-dir (expand-file-name ".git" project-root)))
    (when (file-directory-p git-dir)
      (let* ((hook-path (expand-file-name "hooks/post-commit" git-dir))
             (hook-dir (file-name-directory hook-path))
             (shebang "#!/bin/sh")
             (command "\n# auto-generated by emacs create-tags-git-hook\nglobal -u\n"))
        ;; Ensure hooks directory exists
        (unless (file-exists-p hook-dir)
          (make-directory hook-dir t))

        (if (file-exists-p hook-path)
            (let ((existing-content (with-temp-buffer
                                      (insert-file-contents hook-path)
                                      (buffer-string))))
              (unless (string-match-p (regexp-quote command) existing-content)
                (append-to-file command nil hook-path)))
          (with-temp-file hook-path
            (insert shebang command)))

        (set-file-modes hook-path #o755)
        (message "Git post-commit hook configured for %s" project-root)))))
#+end_src

* Project Switch Integration
Setup GTAGS after switching projects using modern advice-add approach.

#+begin_src emacs-lisp
(defun jf/gtags-after-project-switch (&rest _args)
  "Setup GTAGS after switching projects."
  (when (jf/gtags-check-binary)
    (when jf/gtags-create-git-hooks
      (create-tags-git-hook))
    (when jf/gtags-auto-create-on-project-switch
      (jf/gtags-auto-create-if-needed))))
#+end_src

#+begin_src emacs-lisp
(advice-add 'projectile-switch-project-by-name :after #'jf/gtags-after-project-switch)
(advice-add 'projectile-switch-open-project :after #'jf/gtags-after-project-switch)
(advice-add 'projectile-switch-project :after #'jf/gtags-after-project-switch)
(advice-add 'consult-projectile-switch-project :after #'jf/gtags-after-project-switch)
#+end_src

* GTags Mode Configuration
Configure GTags package with automatic updates and mode-specific enablement.

#+begin_src emacs-lisp
(use-package ggtags
  :straight t
  :custom
  (ggtags-update-on-save t)  ; Auto-update tags on file save
  (ggtags-oversize-limit (* 50 1024 1024))  ; 50MB threshold
  (ggtags-sort-by-nearness nil)

  :config
  ;; Check binary exists
  (jf/gtags-ensure-binary)

  ;; Setup project switching hooks
  (advice-add 'projectile-switch-project-by-name :after #'jf/gtags-after-project-switch)
  (advice-add 'projectile-switch-open-project :after #'jf/gtags-after-project-switch)
  (advice-add 'projectile-switch-project :after #'jf/gtags-after-project-switch)
  (advice-add 'consult-projectile-switch-project :after #'jf/gtags-after-project-switch)

  ;; Enable for programming modes
  (dolist (mode jf/gtags-enabled-modes)
    (add-hook (intern (concat (symbol-name mode) "-hook")) #'ggtags-mode)))
#+end_src

#+begin_src emacs-lisp
;; Set GTAGSLABEL environment variable for pygments-based parsing
(setenv "GTAGSLABEL" "pygments")
#+end_src

* GTags Display Configuration
Configure how GTags displays its results to preserve window layouts.

#+begin_src emacs-lisp
;; Configure how ggtags displays its results
(setq display-buffer-alist
      '(("\\*ggtags-global\\*"
         (display-buffer-reuse-window display-buffer-in-side-window)
         (side . bottom)
         (window-height . 0.3)
         (select-window . t))))

;; (defun my-ggtags-focus-window ()
;;   "Automatically select the ggtags results window."
;;   (let ((ggtags-window (get-buffer-window "*ggtags-global*")))
;;     (when ggtags-window
;;       (select-window ggtags-window))))

;; ;; Hook to focus the ggtags window after a search
;; (add-hook 'ggtags-find-tag-hook 'my-ggtags-focus-window)
#+end_src

* Installation Instructions
This configuration depends on having GTags (GNU Global) installed on your system.

For macOS, install with Homebrew:
#+begin_src sh :tangle no
brew install global
#+end_src

* Usage Notes

** Automatic Tag Management

This configuration automatically manages GTAGS databases:

1. *On project switch*: Creates GTAGS if none exist (async, non-blocking)
2. *On file save*: Updates tags for current file (via ggtags-update-on-save)
3. *On git commit*: Updates all tags (via post-commit hook)

Configuration is transparent - tags "just work" without manual intervention.

** Configuration Variables

Customize behavior:
- ~jf/gtags-auto-create-on-project-switch~ - Auto-create tags (default: t)
- ~jf/gtags-create-git-hooks~ - Auto-create git hooks (default: t)
- ~jf/gtags-enabled-modes~ - Modes to enable ggtags (default: python, js, ts, go, c, c++)
- ~ggtags-update-on-save~ - Update tags on save (default: t)
- ~ggtags-oversize-limit~ - Threshold for update strategy (default: 50MB)

** Basic Commands

- ~M-.~ or ~ggtags-find-tag-dwim~: Find tag under cursor
- ~M-,~ or ~ggtags-prev-mark~: Jump back to previous position
- ~C-c g s~ or ~ggtags-find-other-symbol~: Find references
- ~C-c g h~ or ~ggtags-view-tag-history~: View tag search history

** Manual Commands

- ~M-x ggtags-create-tags~ - Create tags manually (if auto-create disabled)
- ~M-x ggtags-update-tags~ - Update all tags manually
- ~M-x ggtags-delete-tags~ - Remove GTAGS database from project
- ~M-x ggtags-explain-tags~ - Show indexing configuration

** Troubleshooting

If tags aren't working:

1. Check if global is installed: ~which global~ in terminal
2. Check Messages buffer: ~C-h e~ (look for gtags warnings)
3. Check GTAGS exists: ~ls -la GTAGS~ in project root
4. Check tag creation output: ~C-x b *gtags-create*~
5. Manually create tags: ~M-x ggtags-create-tags~
6. Verify pygments installed: ~pip install pygments~ (required for Python/JS/Go/etc)

** Git Integration

The configuration automatically sets up a Git post-commit hook to update tags after each commit.

To manually set up the hook:
#+begin_src sh :tangle no
cat << EOF > .git/hooks/post-commit
#!/bin/sh
global -u
EOF

chmod +x .git/hooks/post-commit
#+end_src

** Update Strategy

Tags stay up to date via:

1. *On file save* (ggtags built-in)
   - Small projects (<50MB): Full update via ~global -u~
   - Large projects (>50MB): Single-file update via ~global --single-update~
   - Async, non-blocking
   - Controlled by ~ggtags-update-on-save~

2. *On git commit* (git post-commit hook)
   - Full update via ~global -u~
   - Catches external changes that get committed
   - Runs in background git process

3. *Manual* (user command)
   - ~M-x ggtags-update-tags~ for full project update
   - Use after major refactoring or if tags feel stale