#+title: Tree-sitter Configuration
#+author: Jeff Farr
#+property: header-args:emacs-lisp :tangle tree-sitter.el
#+auto_tangle: y

* Introduction
This file configures Tree-sitter integration for Emacs, providing enhanced syntax highlighting and structural editing features through incremental parsing.

* Basic Configuration
Setup lexical binding for better closures and variable scoping.

#+begin_src emacs-lisp
;; -*- lexical-binding: t; -*-
#+end_src

* Core Tree-sitter Packages
** Tree-sitter Base
The main Tree-sitter package provides the core functionality for incremental parsing.

[[https://github.com/emacs-tree-sitter/elisp-tree-sitter][Documentation]]

#+begin_src emacs-lisp
(use-package tree-sitter
  :straight t
  :hook ((python-mode . tree-sitter-mode)
         (python-mode . tree-sitter-hl-mode)
         (js-mode . tree-sitter-mode)
         (js-mode . tree-sitter-hl-mode)
         (javascript-mode . tree-sitter-mode)
         (javascript-mode . tree-sitter-hl-mode)
         (sh-mode . tree-sitter-mode)
         (sh-mode . tree-sitter-hl-mode)
         (php-mode . tree-sitter-mode)
         (php-mode . tree-sitter-hl-mode)
         (hcl-mode . tree-sitter-mode)
         (hcl-mode . tree-sitter-hl-mode)
         (terraform-mode . tree-sitter-mode)
         (terraform-mode . tree-sitter-hl-mode)
         (sql-mode . tree-sitter-mode)
         (sql-mode . tree-sitter-hl-mode)))
#+end_src

** Tree-sitter Language Grammars
Provides the language grammar binaries for various programming languages.

[[https://github.com/emacs-tree-sitter/tree-sitter-langs][Documentation]]

#+begin_src emacs-lisp
(use-package tree-sitter-langs
  :straight t)
#+end_src

* Grammar Sources for Built-in Tree-sitter
Configure the sources for downloading and installing built-in Tree-sitter grammar libraries (for Emacs 29+).

**Version Pinning**: Several grammars are pinned to specific versions to maintain ABI version 14 compatibility with Emacs 30.1. The master branches of these grammars have moved to ABI version 15, which causes version-mismatch errors.

**Pinned grammars:**
- bash (v0.21.0), css (v0.21.0), elisp (1.3.0), go (v0.21.1)
- javascript (v0.21.4), python (v0.21.0)
- markdown-inline (v0.2.3 for ABI 14 compatibility)
- sql (requires manual ABI 14 generation - see SQL Grammar section below)

#+begin_src emacs-lisp
(setq treesit-language-source-alist
   '((bash "https://github.com/tree-sitter/tree-sitter-bash" "v0.21.0")
     (cmake "https://github.com/uyha/tree-sitter-cmake")
     (css "https://github.com/tree-sitter/tree-sitter-css" "v0.21.0")
     (elisp "https://github.com/Wilfred/tree-sitter-elisp" "1.3.0")
     (go "https://github.com/tree-sitter/tree-sitter-go" "v0.21.1")
     (html "https://github.com/tree-sitter/tree-sitter-html")
     (javascript "https://github.com/tree-sitter/tree-sitter-javascript" "v0.21.4" "src")
     (json "https://github.com/tree-sitter/tree-sitter-json")
     (make "https://github.com/alemuller/tree-sitter-make")
     (markdown "https://github.com/ikatyang/tree-sitter-markdown")
     (markdown-inline "https://github.com/tree-sitter-grammars/tree-sitter-markdown" "v0.2.3" "tree-sitter-markdown-inline/src")
     (python "https://github.com/tree-sitter/tree-sitter-python" "v0.21.0")
     (toml "https://github.com/tree-sitter/tree-sitter-toml")
     (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
     (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
     (yaml "https://github.com/ikatyang/tree-sitter-yaml")))
#+end_src

* Additional Tree-sitter Packages
** Evil Text Objects for Tree-sitter
Provides Evil text objects based on Tree-sitter's understanding of code structure.

[[https://github.com/meain/evil-textobj-tree-sitter][Documentation]]

#+begin_src emacs-lisp
(use-package evil-textobj-tree-sitter
  :straight t)
#+end_src

** Combobulate
Provides structural editing and navigation capabilities using Tree-sitter.

[[https://github.com/mickeynp/combobulate][Documentation]]

#+begin_src emacs-lisp
(use-package combobulate
  :straight (combobulate :type git :host github :repo "mickeynp/combobulate")
  :hook ((python-mode . combobulate-mode)
         (js-mode . combobulate-mode)
         (typescript-mode . combobulate-mode)))
#+end_src

* Installation Instructions
** For tree-sitter-langs (Emacs 28 and below)
The language grammars should be automatically installed by the package.

** For Built-in Tree-sitter (Emacs 29+)

*** Quick Start: Install and Verify All Grammars

**From command line** (automated install + verification):

#+begin_src bash :tangle no
./bin/emacs-isolated.sh --batch --eval "(progn \
  (mapc #'treesit-install-language-grammar (mapcar #'car treesit-language-source-alist)) \
  (message \"Verification:\") \
  (dolist (lang (mapcar #'car treesit-language-source-alist)) \
    (message \"  %s %s\" (if (treesit-language-available-p lang) \"✓\" \"✗\") lang)))"
#+end_src

**From Emacs** (interactive):

#+begin_src emacs-lisp :tangle no
;; Install all grammars
(mapc #'treesit-install-language-grammar (mapcar #'car treesit-language-source-alist))

;; Verify all grammars
(dolist (lang (mapcar #'car treesit-language-source-alist))
  (message "%s: %s" lang (if (treesit-language-available-p lang) "available" "NOT available")))
#+end_src

*** Installation Location
Grammars are compiled and installed to ~runtime/tree-sitter/~ as ~.dylib~ files (macOS), ~.so~ files (Linux), or ~.dll~ files (Windows).

*** Installing Specific Grammars

Most commonly used:

#+begin_src emacs-lisp :tangle no
(dolist (lang '(python javascript typescript yaml json bash))
  (treesit-install-language-grammar lang))
#+end_src

Single grammar:

#+begin_src emacs-lisp :tangle no
(treesit-install-language-grammar 'python)
#+end_src

*** Troubleshooting

**** ABI Version Mismatch
**Symptom:** Warnings like "version-mismatch: 15" or grammar installs but shows as unavailable.

**Cause:** Emacs 30.1 requires ABI version 14, but grammar's master branch is version 15.

**Solution:** Pin the grammar to a compatible version tag in ~treesit-language-source-alist~.

**Finding compatible version tags:**

#+begin_src bash :tangle no
# List available version tags for a grammar
git ls-remote --tags https://github.com/tree-sitter/tree-sitter-bash | grep -E 'v[0-9]'

# Test which version works (replace bash/v0.21.0 as needed)
./bin/emacs-isolated.sh --batch --eval "(progn \
  (setq treesit-language-source-alist '((bash \"https://github.com/tree-sitter/tree-sitter-bash\" \"v0.21.0\"))) \
  (treesit-install-language-grammar 'bash) \
  (message \"Available: %s\" (treesit-language-available-p 'bash)))"
#+end_src

**Current known working versions** (ABI 14 for Emacs 30.1):
- bash: v0.21.0, css: v0.21.0, elisp: 1.3.0, go: v0.21.1
- javascript: v0.21.4, python: v0.21.0, markdown-inline: v0.2.3

**** C++ Compilation Errors (macOS)
**Symptom:** Errors like ~'cassert' file not found~ or ~'vector' file not found~ when installing markdown or yaml.

**Cause:** C++ compiler can't find standard library headers.

**Solution:** Set SDK path before installation:

#+begin_src bash :tangle no
# From command line
export SDKROOT=$(xcrun --show-sdk-path)
export CPATH="$SDKROOT/usr/include/c++/v1"
./bin/emacs-isolated.sh --batch --eval "(treesit-install-language-grammar 'markdown)"
#+end_src

Or from Emacs:

#+begin_src emacs-lisp :tangle no
(setenv "SDKROOT" (string-trim (shell-command-to-string "xcrun --show-sdk-path")))
(setenv "CPATH" (concat (getenv "SDKROOT") "/usr/include/c++/v1"))
(treesit-install-language-grammar 'markdown)
#+end_src

**** Missing C Compiler
Grammar installation requires a C/C++ compiler.

#+begin_src bash :tangle no
# macOS - install Xcode Command Line Tools
xcode-select --install
clang --version

# Linux
gcc --version
#+end_src

**** Reinstalling Grammars

**When to reinstall:**
- After changing version pins in ~treesit-language-source-alist~
- ABI version mismatch errors
- Grammar files corrupted
- After Emacs major version update

**Remove and reinstall specific grammar:**

#+begin_src bash :tangle no
# Remove grammar (adjust extension: .dylib macOS, .so Linux, .dll Windows)
rm runtime/tree-sitter/libtree-sitter-python.dylib

# Reinstall
./bin/emacs-isolated.sh --batch --eval "(treesit-install-language-grammar 'python)"
#+end_src

**Clean install (all grammars):**

#+begin_src bash :tangle no
# Remove all grammars
rm -rf runtime/tree-sitter/*

# Reinstall all (includes verification)
./bin/emacs-isolated.sh --batch --eval "(progn \
  (mapc #'treesit-install-language-grammar (mapcar #'car treesit-language-source-alist)) \
  (dolist (lang (mapcar #'car treesit-language-source-alist)) \
    (message \"%s %s\" (if (treesit-language-available-p lang) \"✓\" \"✗\") lang)))"
#+end_src

**Important:** The ~runtime/tree-sitter/~ directory is gitignored. Each worktree needs its own grammar installation (not shared between worktrees).

*** Installing SQL Grammar (Special Case)

The DerekStride/tree-sitter-sql grammar only provides ABI version 15 pre-built parsers, which are incompatible with Emacs 30.1 (requires ABI 14). You must manually generate ABI 14 parser files.

**Prerequisites:**
- tree-sitter CLI: ~npm install -g tree-sitter-cli~
- C compiler (already required for other grammars)

**Installation steps:**

#+begin_src bash :tangle no
# 1. Install tree-sitter CLI if not already installed
npm install -g tree-sitter-cli

# 2. Clone and generate ABI 14 parser
cd /tmp
git clone --depth 1 --branch v0.3.11 https://github.com/DerekStride/tree-sitter-sql.git
cd tree-sitter-sql
tree-sitter generate --abi=14

# 3. Copy parser files to local directory
mkdir -p ~/emacs/runtime/tree-sitter-sql-local
cp -r src/*.c src/tree_sitter ~/emacs/runtime/tree-sitter-sql-local/

# 4. Compile to dylib (macOS), .so (Linux), or .dll (Windows)
cd ~/emacs/runtime/tree-sitter-sql-local
cc -fPIC -c -I. parser.c
cc -fPIC -c -I. scanner.c
cc -fPIC -shared parser.o scanner.o -o ../tree-sitter/libtree-sitter-sql.dylib

# 5. Verify in Emacs
# Should return t:
# (treesit-language-available-p 'sql)
#+end_src

**Why this is needed:**
- tree-sitter-sql stores pre-built parsers on ~gh-pages~ branch (not version tags)
- ~gh-pages~ branch uses ABI version 15 (incompatible with Emacs 30.1)
- Using ~tree-sitter generate --abi=14~ creates compatible parsers from grammar source

**Future:** This workaround won't be needed when Emacs supports ABI version 15 or when tree-sitter-sql provides ABI 14 builds.

* Usage Notes
** Benefits of Tree-sitter
Tree-sitter provides several advantages over traditional syntax highlighting:

- More accurate and resilient syntax highlighting
- Better code navigation based on structural understanding of code
- Incremental parsing for better performance with large files
- Foundation for advanced refactoring and structural editing

** Using Combobulate
Combobulate provides intelligent structural editing commands:

- `C-c o n`: Navigate to the next logical node
- `C-c o p`: Navigate to the previous logical node
- `C-c o u`: Navigate up to the parent node
- `C-c o d`: Navigate down to the first child node
- `C-c o s`: Surround the current region with a template

** Using Evil Text Objects
With evil-textobj-tree-sitter, you can use structural text objects:

- `af`: A function
- `if`: Inner function (without function declaration)
- `ac`: A class
- `ic`: Inner class (without class declaration)

* TODO Improvements
- Add configuration for tree-sitter-based indentation modes
- Configure tree-sitter query patterns for custom highlighting
- Add additional language mode hooks
- Enable more Evil text objects for different code structures
- Consider adding more languages to the grammar list
