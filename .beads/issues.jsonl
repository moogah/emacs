{"id":"emacs-164","title":"[HIGH] PersistentAgent: Missing exception handling in callback - can crash and leave overlay dangling","description":"## Problem\n\nCallback function has no exception handling wrapper, causing Emacs crashes and dangling overlays on unexpected errors.\n\n## Spec Requirement\n\n**openspec/specs/gptel/persistent-agent.md lines 398-402:**\n\u003e WHEN callback encounters unexpected exception during response processing\n\u003e THEN the system should catch and handle gracefully\n\u003e AND log error with context for debugging\n\u003e AND invoke parent callback with error message (not crash)\n\n## Current Implementation\n\n**config/gptel/tools/persistent-agent.org lines 718-770:**\nCallback has no condition-case wrapper around response processing logic.\n\n## Impact\n\n- Uncaught exception crashes Emacs\n- Overlay left dangling in parent buffer (never cleaned up)\n- Parent callback never invoked with error\n- No error logging for debugging\n\n## Fix\n\nWrap callback body in condition-case:\n```elisp\n:callback\n(lambda (resp info \u0026optional raw)\n  (condition-case err\n      (let ((ov (plist-get info :context))\n            (buf (plist-get info :buffer)))\n        ;; ... existing callback logic ...\n        )\n    (error\n     (let ((ov (plist-get info :context)))\n       (when (overlay-buffer ov) (delete-overlay ov))\n       (jf/gptel--log 'error \"Agent callback error: %S\" err)\n       (funcall main-cb (format \"Error: Agent callback failed: %S\" err))))))\n```\n\n## Verification\n\nAgent ID: a346c94","status":"open","priority":2,"issue_type":"task","owner":"moogah@gmail.com","created_at":"2026-02-08T12:19:04.757082+01:00","created_by":"Jeff Farr","updated_at":"2026-02-08T12:19:04.757082+01:00"}
{"id":"emacs-49a","title":"[MEDIUM] PersistentAgent: Empty array path behavior differs from spec","description":"## Problem\n\nSpec says allowed_paths=[] should mean \"no path restrictions\", but implementation treats it same as omitting the parameter (inherits from parent).\n\n## Spec Requirement\n\n**openspec/specs/gptel/persistent-agent.md lines 31-37:**\n\u003e Scenario: Optional path inheritance from parent\n\u003e - WHEN allowed_paths is not provided (nil)\n\u003e - THEN the agent inherits allowed read paths from parent's preset.md\n\u003e - WHEN allowed_paths is provided as empty array []\n\u003e - THEN the agent has no path restrictions (reads from anywhere)\n\u003e - WHEN allowed_paths is provided with patterns\n\u003e - THEN the agent uses exactly those patterns (no inheritance)\n\n## Current Implementation\n\n**config/gptel/tools/persistent-agent.org lines 598-616:**\n```elisp\n(effective-allowed-paths\n (or allowed-paths-list  ; Empty list is falsy, falls through\n     ;; Inherit from parent\n     (let ((parent-preset-file ...))\n       (plist-get parent-config :paths-read))))\n```\n\nWhen allowed_paths=[] (empty array):\n1. JSON deserializes to empty vector []\n2. `(append [] nil)` converts to empty list nil\n3. `(or nil ...)` evaluates falsy → falls through to parent inheritance\n\n## Impact\n\n- Users cannot create unrestricted agents by passing []\n- Must use wildcard pattern [\"/**\"] instead\n- Behavior doesn't match spec intention to distinguish \"not provided\" from \"empty array provided\"\n\n## Fix\n\nDistinguish nil from empty list:\n```elisp\n(effective-allowed-paths\n (if (null allowed-paths)\n     ;; Parameter not provided → inherit from parent\n     (let ((parent-preset-file (expand-file-name \"preset.md\" jf/gptel--session-dir)))\n       (when (file-exists-p parent-preset-file)\n         (let ((parent-config (jf/gptel-scope--parse-preset-config parent-preset-file)))\n           (plist-get parent-config :paths-read))))\n   ;; Parameter provided (even if empty list) → use as-is (empty = unrestricted)\n   (append allowed-paths nil)))\n```\n\n## Alternative\n\nUpdate spec to say both nil and [] inherit from parent (simpler, matches current behavior).\n\n## Verification\n\nAgent ID: ac91998","status":"closed","priority":2,"issue_type":"task","owner":"moogah@gmail.com","created_at":"2026-02-08T12:19:40.07278+01:00","created_by":"Jeff Farr","updated_at":"2026-02-09T14:22:26.508727+01:00","closed_at":"2026-02-09T14:22:26.508727+01:00","close_reason":"Closed"}
{"id":"emacs-axq","title":"[MEDIUM] PersistentAgent: Filesystem errors not logged or reported","description":"## Problem\n\nDirectory creation, file copy, and metadata write operations have no error handling, leading to silent failures.\n\n## Spec Requirement\n\n**openspec/specs/gptel/persistent-agent.md lines 393-396:**\n\u003e WHEN directory creation, file copy, or metadata write fails\n\u003e THEN the system logs error via jf/gptel--log at 'error level\n\u003e AND propagates error to caller (does not silently continue)\n\n## Current Implementation\n\n**config/gptel/tools/persistent-agent.org lines 584-640:**\nFilesystem operations have NO error handling:\n- Line 584-586: `jf/gptel--create-agent-directory` - no error check\n- Line 589: `jf/gptel--copy-preset-template` - no error check\n- Lines 632-640: `with-temp-file scope-file` - no error catching\n\nOnly SUCCESS is logged (lines 624-626), not failures.\n\n## Impact\n\n- Silent failures could leave inconsistent state\n- Partial directory creation with missing files\n- No debugging information when creation fails\n- Error not propagated to user\n\n## Fix\n\nWrap filesystem operations in condition-case:\n```elisp\n(condition-case err\n    (progn\n      ;; Directory creation\n      (let* ((session-dir (jf/gptel--create-agent-directory \n                           jf/gptel--branch-dir preset description)))\n        ;; Preset template copy\n        (jf/gptel--copy-preset-template preset session-dir)\n        ;; ... rest of operations ...\n        ))\n  (error\n   (jf/gptel--log 'error \"Failed to create agent session: %S\" err)\n   (signal (car err) (cdr err))))  ; Re-raise after logging\n```\n\n## Verification\n\nAgent ID: a346c94","status":"open","priority":2,"issue_type":"task","owner":"moogah@gmail.com","created_at":"2026-02-08T12:19:21.336278+01:00","created_by":"Jeff Farr","updated_at":"2026-02-08T12:19:21.336278+01:00"}
{"id":"emacs-d76","title":"Add application and serialization phase functions","description":"Complete preset-configuration module with apply and serialize phases, finishing the bidirectional pipeline.\n\nFiles to modify:\n- config/gptel/preset-configuration.org\n\nImplementation steps:\n1. Implement jf/gptel-preset-apply (resolved plist → buffer-local vars)\n   - Set (setq-local gptel-backend (plist-get resolved :backend))\n   - Set (setq-local gptel-model (plist-get resolved :model))\n   - Set (setq-local gptel-tools (plist-get resolved :tools)) (always set, even if nil, for isolation)\n   - Set (setq-local gptel-temperature (plist-get resolved :temperature)) (only if present)\n   - Call jf/gptel--set-session-system-message with :system value\n2. Implement jf/gptel-preset-serialize (resolved plist → parsed plist)\n   - Extract backend name: (gptel-backend-name backend)\n   - Convert model symbol: (symbol-name model)\n   - Extract tool names: map (gptel-tool-name tool) over tools list\n   - Normalize tool plist format (:tool1 (:allowed t)) to simple array\n   - Pass through other fields unchanged\n   - Return serialized plist with strings/numbers/lists only\n3. Load module in config/gptel/gptel.org after skills, before sessions\n\nDesign rationale:\nApply phase sets buffer-local variables, making configuration take effect. Tools are always set explicitly (even nil) to prevent global tool leakage across buffers. Serialize phase is inverse of resolve, normalizing internal representations to canonical file format. This enables round-trip: file → parse → resolve → apply → serialize → file.\n\nDesign pattern:\n```elisp\n(defun jf/gptel-preset-apply (resolved)\n  \"Apply RESOLVED preset plist to current buffer's local variables.\"\n  (setq-local gptel-backend (plist-get resolved :backend))\n  (setq-local gptel-model (plist-get resolved :model))\n  (setq-local gptel-tools (plist-get resolved :tools))  ; Always set for isolation\n  (when-let ((temp (plist-get resolved :temperature)))\n    (setq-local gptel-temperature temp))\n  (when-let ((system (plist-get resolved :system)))\n    (jf/gptel--set-session-system-message system)))\n```\n\nVerification:\n- Tangle and validate\n- Test apply in temporary buffer (check buffer-local vars set correctly)\n- Test serialize with resolved plist (check output matches parsed format)\n- Test serialize with tool plist format (should normalize to array)\n- Load module via (jf/load-module \"gptel/preset-configuration\") in gptel.org\n\nContext: design.md § Decision 3: Serialization as inverse of resolution, § Decision 5: Update call sites to use new architecture","status":"open","priority":2,"issue_type":"task","owner":"moogah@gmail.com","estimated_minutes":90,"created_at":"2026-02-10T22:31:55.114099+01:00","created_by":"Jeff Farr","updated_at":"2026-02-10T22:31:55.114099+01:00","external_ref":"opsx:gptel-preset-refactor:bead-3","labels":["gptel-preset-refactor","openspec","preset-configuration"],"dependencies":[{"issue_id":"emacs-d76","depends_on_id":"emacs-mvt","type":"blocks","created_at":"2026-02-10T22:31:55.116756+01:00","created_by":"Jeff Farr"}]}
{"id":"emacs-edl","title":"Create preset configuration module with resolver functions","description":"Create new module config/gptel/preset-configuration.org with core resolver functions for backend, model, and tool name lookups.\n\nFiles to create:\n- config/gptel/preset-configuration.org\n\nImplementation steps:\n1. Create literate org file with proper header (#+title, #+property: header-args:emacs-lisp :tangle preset-configuration.el)\n2. Implement jf/gptel-preset--resolve-backend (name string → gptel-backend struct)\n   - Look up in gptel--known-backends alist\n   - Signal error if not found (backend is required, no default)\n   - Pass through unchanged if already a struct (idempotent)\n3. Implement jf/gptel-preset--resolve-model (name string → symbol)\n   - Convert string to symbol via intern\n   - Pass through unchanged if already symbol (idempotent)\n4. Implement jf/gptel-preset--resolve-tools (name strings → tool struct list)\n   - Iterate tool names, call gptel-get-tool for each\n   - Log warnings for missing tools\n   - Return nil if all missing, partial list if some succeed\n   - Filter out nil results\n\nDesign rationale:\nResolver functions centralize type conversion logic with consistent error handling. Making them idempotent (pass through if already correct type) makes them safe to call multiple times and simplifies testing. Tools resolver is permissive (warns but continues) because missing tools is non-fatal, while backend resolver is strict (signals error) because backend is required.\n\nDesign pattern:\n```elisp\n(defun jf/gptel-preset--resolve-backend (backend)\n  \"Convert BACKEND name string to gptel-backend struct, or pass through if already struct.\"\n  (cond\n   ((gptel-backend-p backend) backend)  ; Already resolved\n   ((stringp backend)\n    (or (alist-get backend gptel--known-backends nil nil #'string=)\n        (error \"Unknown backend: %s\" backend)))\n   (t (error \"Invalid backend type: %s\" (type-of backend)))))\n```\n\nVerification:\n- Tangle with ./bin/tangle-org.sh config/gptel/preset-configuration.org\n- Test resolver idempotency (calling twice returns same result)\n- Test backend resolver with unknown name (should signal error)\n- Test tools resolver with partial missing (should return partial list + warnings)\n\nContext: design.md § Decision 2: Resolver functions for each type","status":"open","priority":2,"issue_type":"task","owner":"moogah@gmail.com","estimated_minutes":150,"created_at":"2026-02-10T22:31:06.323652+01:00","created_by":"Jeff Farr","updated_at":"2026-02-10T22:31:06.323652+01:00","external_ref":"opsx:gptel-preset-refactor","labels":["gptel-preset-refactor","openspec","preset-configuration"]}
{"id":"emacs-gcm","title":"Implement missing activities-ext--prompt-git-action function","description":"Function is called in config/activities/core.el:332 but never defined, breaking the activities-ext-add-project command.\n\n**Context:**\n- Called by: activities-ext-add-project in core.el line 332\n- Expected signature: (activities-ext--prompt-git-action project-path sanitized-name activity-name)\n- Expected return: plist with :branch and :worktree keys (same as activities-ext--apply-git-action)\n\n**Impact:**\n- activities-ext-add-project command is broken (undefined function error at runtime)\n- Transient UI workflow unaffected (uses activities-ext--apply-git-action directly)\n\n**Implementation Notes:**\n- Should prompt user to choose git action (worktree, branch, or none)\n- Should call activities-ext--apply-git-action with user's choice\n- Consider using completing-read or y-or-n-p for UX\n\n**Related:**\n- activities-ext--apply-git-action exists in projectile.el:41-64\n- Transient workflow in transient.el:399-491 shows proper usage pattern","status":"open","priority":2,"issue_type":"bug","owner":"moogah@gmail.com","created_at":"2026-02-21T11:40:53.744202+01:00","created_by":"Jeff Farr","updated_at":"2026-02-21T11:40:53.744202+01:00"}
{"id":"emacs-i28","title":"[MEDIUM] PersistentAgent: Overlay validity not checked before deletion","description":"## Problem\n\nOverlay deletion calls don't check if overlay buffer still exists, causing failures when parent buffer is killed during execution.\n\n## Spec Requirement\n\n**openspec/specs/gptel/persistent-agent.md lines 290-295:**\n\u003e Overlay validity checked before updates\n\u003e - WHEN FSM handler tries to update overlay\n\u003e - THEN the system checks (overlay-buffer overlay) returns non-nil\n\u003e - AND skips update if parent buffer was killed\n\u003e - AND prevents crashes from dangling overlay references\n\n**Lines 404-408:**\n\u003e Overlay always cleaned up\n\u003e - WHEN ANY terminal state is reached\n\u003e - THEN the callback MUST call (delete-overlay ov)\n\u003e - AND no dangling overlays persist after completion\n\n## Current Implementation\n\n**config/gptel/tools/persistent-agent.org:**\n- Line 725: `(delete-overlay ov)` - no validity check (network error path)\n- Line 732: `(delete-overlay ov)` - no validity check (user abort path)  \n- Line 766: `(delete-overlay ov)` - no validity check (success path)\n\nFSM handlers DO check validity (lines 505, 523), but deletion sites don't.\n\n## Impact\n\n- Could fail/error if parent buffer killed during agent execution\n- Inconsistent with overlay update pattern (which checks validity)\n\n## Fix\n\nWrap all delete-overlay calls with validity check:\n```elisp\n(when (overlay-buffer ov)\n  (delete-overlay ov))\n```\n\nApply to lines 725, 732, 766.\n\n## Verification\n\nAgent ID: a346c94","status":"open","priority":2,"issue_type":"task","owner":"moogah@gmail.com","created_at":"2026-02-08T12:19:28.309172+01:00","created_by":"Jeff Farr","updated_at":"2026-02-08T12:19:28.309172+01:00"}
{"id":"emacs-imh","title":"[CRITICAL] PersistentAgent: Wrong tool category - should be 'meta' not 'gptel-persistent'","description":"## Problem\n\nPersistentAgent tool is registered with wrong category, preventing it from bypassing scope validation as specified.\n\n## Spec Requirement\n\n**openspec/specs/gptel/persistent-agent.md lines 20, 39-42:**\n- Tool SHALL be categorized as 'meta' in the scope system\n- Meta tools bypass scope validation for tool invocation itself\n- Agent's own tools still respect agent's scope\n\n## Current Implementation\n\n**config/gptel/tools/persistent-agent.org line 823:**\n```elisp\n:category \"gptel-persistent\"\n```\n\n## Impact\n\n- PersistentAgent may be subject to scope validation checks when invoked by parent sessions\n- Could prevent agents from spawning in sessions with restrictive scope configurations\n- Contradicts explicit spec requirement for scope bypass\n\n## Fix\n\nChange line 823 from:\n```elisp\n:category \"gptel-persistent\"\n```\n\nTo:\n```elisp\n:category \"meta\"\n```\n\n## Verification\n\nAgent ID: a3a5442","status":"open","priority":2,"issue_type":"task","owner":"moogah@gmail.com","created_at":"2026-02-08T12:18:58.924545+01:00","created_by":"Jeff Farr","updated_at":"2026-02-08T12:18:58.924545+01:00"}
{"id":"emacs-mvt","title":"Add parsing and resolution phase functions","description":"Add parse and resolve phase functions to preset-configuration module, establishing the three-phase pipeline.\n\nFiles to modify:\n- config/gptel/preset-configuration.org\n\nImplementation steps:\n1. Implement jf/gptel-preset-parse (file path → parsed plist)\n   - Read file contents\n   - Detect format (.md uses YAML frontmatter, .org uses PROPERTIES drawer)\n   - For .md: use yaml-parse-string on frontmatter, extract markdown body as :system\n   - For .org: parse PROPERTIES drawer, extract org body as :system\n   - Return plist with strings/numbers/lists only (no structs/symbols)\n   - Return nil on parse failure, log error with file path\n2. Implement jf/gptel-preset-resolve (parsed plist → resolved plist)\n   - Call jf/gptel-preset--resolve-backend on :backend\n   - Call jf/gptel-preset--resolve-model on :model\n   - Call jf/gptel-preset--resolve-tools on :tools\n   - Pass through other fields unchanged (temperature, system, etc.)\n   - Return resolved plist with structs/symbols\n3. Add comprehensive docstrings documenting intermediate representation contracts\n\nDesign rationale:\nParse phase extracts data without performing lookups (separation of concerns). This makes parsing independently testable and allows inspection of raw data before resolution. Resolve phase performs all lookups in one pass, making it easy to handle errors consistently. Each phase has explicit input/output contract documented in docstrings.\n\nDesign pattern - Parsed plist:\n```elisp\n(:backend \"Claude\"\n :model \"claude-opus-4-5\"\n :temperature 1.0\n :tools (\"read_file\" \"write_file_in_scope\")\n :system \"message text...\")\n```\n\nDesign pattern - Resolved plist:\n```elisp\n(:backend \u003cgptel-backend struct\u003e\n :model 'claude-opus-4-5\n :temperature 1.0\n :tools (\u003cgptel-tool struct\u003e \u003cgptel-tool struct\u003e)\n :system \"message text...\")\n```\n\nVerification:\n- Tangle and validate\n- Test parse with valid .md preset (check structure matches expected)\n- Test parse with invalid YAML (should return nil + error log)\n- Test resolve with valid parsed plist (check types are correct)\n- Test resolve with unknown backend (should signal error)\n\nContext: design.md § Decision 1: Three-phase architecture (Parse → Resolve → Apply)","status":"open","priority":2,"issue_type":"task","owner":"moogah@gmail.com","estimated_minutes":150,"created_at":"2026-02-10T22:31:37.919426+01:00","created_by":"Jeff Farr","updated_at":"2026-02-10T22:31:37.919426+01:00","external_ref":"opsx:gptel-preset-refactor:bead-2","labels":["gptel-preset-refactor","openspec","preset-configuration"],"dependencies":[{"issue_id":"emacs-mvt","depends_on_id":"emacs-edl","type":"blocks","created_at":"2026-02-10T22:31:37.922288+01:00","created_by":"Jeff Farr"}]}
{"id":"emacs-qi7","title":"Update PersistentAgent to use three-phase pipeline","description":"Refactor agent preset loading in persistent-agent.org to use parse → resolve → apply pipeline with strict error handling.\n\nFiles to modify:\n- config/gptel/tools/persistent-agent.org\n\nImplementation steps:\n1. Locate agent initialization logic in jf/gptel-persistent-agent-call\n2. Find preset loading within agent buffer's with-current-buffer\n3. Replace with three-phase pipeline:\n   ```elisp\n   (let* ((preset-path (expand-file-name \"preset.md\" agent-dir))\n          (parsed (jf/gptel-preset-parse preset-path))\n          (resolved (jf/gptel-preset-resolve parsed)))\n     (unless (and parsed resolved)\n       (error \"Agent preset loading failed: %s\" preset-path))\n     (jf/gptel-preset-apply resolved))\n   ```\n4. Ensure buffer-local session variables set BEFORE preset application\n5. Verify tools captured AFTER preset application (within agent buffer context)\n6. Update error handling to fail fast (agents require valid presets, no defaults)\n\nDesign rationale:\nAgents use strict error handling (signal errors) because agent execution without proper configuration is dangerous - could leak parent's tools/backend. Loading preset within agent buffer's with-current-buffer ensures buffer-local variables set in correct context. Tools must be captured after preset application to get agent's tools, not parent's.\n\nDesign pattern:\n```elisp\n;; In agent buffer context\n(with-current-buffer agent-buffer\n  ;; Set session variables first\n  (setq-local jf/gptel--session-id agent-session-id)\n  (setq-local jf/gptel--session-dir agent-dir)\n  (setq-local jf/gptel--branch-name \"main\")\n  (setq-local jf/gptel--branch-dir agent-dir)\n  \n  ;; Load and apply preset (fail fast on errors)\n  (let* ((preset-path (expand-file-name \"preset.md\" agent-dir))\n         (parsed (or (jf/gptel-preset-parse preset-path)\n                     (error \"Failed to parse agent preset: %s\" preset-path)))\n         (resolved (jf/gptel-preset-resolve parsed)))\n    (jf/gptel-preset-apply resolved))\n  \n  ;; Capture tools from agent buffer context\n  (setq agent-tools gptel-tools))\n```\n\nVerification:\n- Tangle and validate\n- Create agent with preset → verify configuration isolated from parent\n- Create agent with invalid preset → verify error signaled (no partial state)\n- Verify agent uses tools from its preset, not parent's\n- Test agent with different backend than parent → verify no leakage\n\nContext: design.md § Decision 5: Update call sites to use new architecture, § Migration Plan step 3","status":"open","priority":2,"issue_type":"task","owner":"moogah@gmail.com","estimated_minutes":90,"created_at":"2026-02-10T22:39:31.007157+01:00","created_by":"Jeff Farr","updated_at":"2026-02-10T22:39:31.007157+01:00","external_ref":"opsx:gptel-preset-refactor:bead-5","labels":["gptel-preset-refactor","openspec","persistent-agent"],"dependencies":[{"issue_id":"emacs-qi7","depends_on_id":"emacs-d76","type":"blocks","created_at":"2026-02-10T22:39:31.009585+01:00","created_by":"Jeff Farr"}]}
{"id":"emacs-ueh","title":"[HIGH] PersistentAgent: Empty session.md not created upfront - only after first auto-save","description":"## Problem\n\nSpec requires creating empty session.md file during agent creation, but implementation only associates buffer with file path without creating the file.\n\n## Spec Requirement\n\n**openspec/specs/gptel/persistent-agent.md lines 110-113:**\n\u003e Scenario: Empty session.md created\n\u003e - WHEN creating an agent session\n\u003e - THEN the system creates an empty `session.md` file\n\u003e - AND associates the file with the agent buffer via set-visited-file-name\n\n## Current Implementation\n\n**config/gptel/tools/persistent-agent.org lines 681-683:**\n```elisp\n;; Associate buffer with file\n(set-visited-file-name (jf/gptel--context-file-path session-dir))\n(set-buffer-modified-p t)\n```\n\nOnly calls set-visited-file-name, which does NOT create the file on disk.\n\n## Impact\n\n- Agent directory initially contains only: preset.md, scope-plan.yml\n- session.md doesn't exist until first auto-save after first API response\n- Directory structure incomplete until first auto-save\n- Could break tools expecting session.md to exist immediately after creation\n- Timing differs from spec\n\n## Fix\n\nCreate empty file before associating:\n```elisp\n;; Create empty session.md and associate buffer with file\n(let ((session-file (jf/gptel--context-file-path session-dir)))\n  (with-temp-file session-file\n    (insert \"\"))  ; Create empty file\n  (set-visited-file-name session-file)\n  (set-buffer-modified-p nil))  ; File exists and is empty, not modified\n```\n\n## Verification\n\nAgent ID: ab7db55","status":"open","priority":2,"issue_type":"task","owner":"moogah@gmail.com","created_at":"2026-02-08T12:19:13.93533+01:00","created_by":"Jeff Farr","updated_at":"2026-02-08T12:19:13.93533+01:00"}
{"id":"emacs-uwm","title":"[MINOR] PersistentAgent: Documentation describes spec intent not implementation for empty array behavior","description":"## Problem\n\nDocumentation claims empty array allows unrestricted access, but implementation inherits from parent.\n\n## Documentation\n\n**config/gptel/tools/persistent-agent.org lines 566-567:**\n\u003e If specified as empty array [], agent has no path restrictions (reads from anywhere).\n\n## Actual Implementation Behavior\n\n**Lines 598-616:**\nEmpty array converts to nil and falls through to parent inheritance logic.\n\n## Impact\n\n- Documentation misleads users about empty array behavior\n- Users following documentation will have incorrect expectations\n- Documentation describes spec intention, not actual behavior\n\n## Fix Options\n\n**Option 1:** Update documentation to match implementation:\n\u003e If omitted or specified as empty array [], agent inherits allowed paths from parent.\n\n**Option 2:** Fix implementation to match documentation (see bead for empty array path behavior).\n\n## Related\n\nThis is a documentation consequence of the empty array path behavior delta. Consider resolving both together.\n\n## Verification\n\nAgent ID: ac91998","status":"closed","priority":2,"issue_type":"task","owner":"moogah@gmail.com","created_at":"2026-02-08T12:19:45.240284+01:00","created_by":"Jeff Farr","updated_at":"2026-02-09T14:22:26.514774+01:00","closed_at":"2026-02-09T14:22:26.514774+01:00","close_reason":"Closed"}
{"id":"emacs-wej","title":"Update sessions persistence to use three-phase pipeline","description":"Refactor session initialization in commands.org to use parse → resolve → apply pipeline instead of monolithic preset loading.\n\nFiles to modify:\n- config/gptel/sessions/commands.org\n\nImplementation steps:\n1. Locate jf/gptel--session--open-hook function\n2. Replace preset loading logic with three-phase pipeline:\n   ```elisp\n   (when-let* ((preset-path (expand-file-name \"preset.md\" branch-dir))\n               (parsed (jf/gptel-preset-parse preset-path))\n               (resolved (jf/gptel-preset-resolve parsed)))\n     (jf/gptel-preset-apply resolved))\n   ```\n3. Update error handling to check for nil after parsing (graceful fallback)\n4. Locate preset serialization during session creation\n5. Replace jf/gptel--normalize-preset-for-serialization with jf/gptel-preset-serialize\n6. Remove deprecated functions:\n   - Delete jf/gptel--load-preset-from-file\n   - Delete jf/gptel--apply-session-preset\n   - Delete jf/gptel--normalize-preset-for-serialization\n7. Grep codebase to ensure no remaining references to deleted functions\n\nDesign rationale:\nThree-phase pipeline makes data flow visible at call sites. Sessions use graceful error handling (nil checks) because preset loading failure should not crash session opening - user can still interact with session using defaults. Explicit phases make debugging easier (can inspect parsed or resolved data).\n\nDesign pattern:\n```elisp\n;; In session open hook\n(when-let* ((preset-path (expand-file-name \"preset.md\" branch-dir))\n            (parsed (jf/gptel-preset-parse preset-path)))\n  (condition-case err\n      (jf/gptel-preset-apply (jf/gptel-preset-resolve parsed))\n    (error\n     (message \"Preset resolution failed: %s. Using defaults.\" (error-message-string err)))))\n```\n\nVerification:\n- Tangle both files and validate\n- Open existing session → verify backend/model/tools/system loaded correctly\n- Create new session → verify preset.md written in canonical format\n- Parse preset with missing tools → verify warnings logged, partial list used\n- Parse preset with invalid YAML → verify graceful fallback to defaults\n- Grep for deprecated function names → should find zero references\n\nContext: design.md § Decision 5: Update call sites to use new architecture, § Migration Plan step 2","status":"open","priority":2,"issue_type":"task","owner":"moogah@gmail.com","estimated_minutes":150,"created_at":"2026-02-10T22:36:33.085754+01:00","created_by":"Jeff Farr","updated_at":"2026-02-10T22:36:33.085754+01:00","external_ref":"opsx:gptel-preset-refactor:bead-4","labels":["gptel-preset-refactor","openspec","sessions-persistence"],"dependencies":[{"issue_id":"emacs-wej","depends_on_id":"emacs-d76","type":"blocks","created_at":"2026-02-10T22:36:33.089308+01:00","created_by":"Jeff Farr"}]}
{"id":"emacs-x0a","title":"Bounds filtering includes partial overlaps despite docstring claiming exclusion","description":"**Bug**: The `jf/gptel--filter-bounds-before-position` function includes regions that start before but end after the branch point, contradicting its own docstring.\n\n**Location**: `config/gptel/sessions/branching.el:69-87`\n\n**Discrepancy**:\n- **Docstring (line 72)**: \"Regions that start before but end after POSITION are EXCLUDED (partial overlap)\"\n- **Implementation (line 82)**: Only checks `(\u003c (car region) position)` - does NOT check end position\n\n**Example**:\n```\nBranch point: 5420\nRegion: (4000 6000) - starts at 4000, ends at 6000\n\nExpected (per docstring): EXCLUDE (partial overlap)\nActual behavior: INCLUDE (only start checked)\n```\n\n**Impact**: \n- Branch bounds may include conversation elements that extend past the branch point\n- Could lead to unexpected content in branched sessions\n- Violates principle of clean truncation at branch point\n\n**Suggested Fix**:\nAdd end-position check to match docstring:\n```elisp\n(lambda (region)\n  ;; Include only if region ENDS before branch point\n  (\u003c (cadr region) position))\n```\n\nOr update docstring if current behavior is intended.\n\n**Discovered During**: OpenSpec sessions-branching spec verification","status":"open","priority":2,"issue_type":"task","owner":"moogah@gmail.com","created_at":"2026-02-05T14:20:07.407941+01:00","created_by":"Jeff Farr","updated_at":"2026-02-05T14:20:07.407941+01:00","labels":["branching","bug","gptel","sessions"]}
{"id":"emacs-xac","title":"[HIGH] PersistentAgent: tools.org file never created during agent initialization","description":"## Problem\n\nAgent directory structure spec lists tools.org as required file, but implementation never creates it.\n\n## Spec Requirement\n\n**openspec/specs/gptel/persistent-agent.md line 60:**\n```\n└── tools.org            (agent tool execution log)\n```\n\n## Current Implementation\n\nNo code in persistent-agent.org creates tools.org during agent session initialization.\n\n## Impact\n\n- Agent directory structure incomplete\n- May break tools/processes expecting this file to exist\n- Documentation (line 165) claims file exists but it doesn't\n\n## Fix\n\nAdd file creation during agent initialization (around line 640):\n```elisp\n;; Create empty tools.org file\n(let ((tools-file (expand-file-name \"tools.org\" session-dir)))\n  (with-temp-file tools-file\n    (insert \"\")))\n```\n\nOR clarify if tools.org is created lazily on first tool execution, and update spec accordingly.\n\n## Verification\n\nAgent ID: ab7db55","status":"open","priority":2,"issue_type":"task","owner":"moogah@gmail.com","created_at":"2026-02-08T12:19:02.623371+01:00","created_by":"Jeff Farr","updated_at":"2026-02-08T12:19:02.623371+01:00"}
